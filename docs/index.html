<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Good Practices for Ansible - GPA</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Good Practices for Ansible - GPA</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_where_to_get_and_maintain_this_document">1.1. Where to get and maintain this document</a></li>
</ul>
</li>
<li><a href="#_automation_structures">2. Automation structures</a>
<ul class="sectlevel2">
<li><a href="#_guiding_principles_for_automation_good_practices">2.1. Guiding principles for Automation Good Practices</a></li>
<li><a href="#_define_which_structure_to_use_for_which_purpose">2.2. Define which structure to use for which purpose</a></li>
</ul>
</li>
<li><a href="#_roles_good_practices_for_ansible">3. Roles Good Practices for Ansible</a>
<ul class="sectlevel2">
<li><a href="#_role_design_considerations">3.1. Role design considerations</a>
<ul class="sectlevel3">
<li><a href="#_basic_design">3.1.1. Basic design</a></li>
<li><a href="#_role_structure">3.1.2. Role Structure</a></li>
<li><a href="#_role_distribution">3.1.3. Role Distribution</a></li>
<li><a href="#_naming_parameters">3.1.4. Naming parameters</a></li>
<li><a href="#_providers">3.1.5. Providers</a></li>
<li><a href="#_distributions_and_versions">3.1.6. Distributions and Versions</a></li>
<li><a href="#_package_roles_in_an_ansible_collection_to_simplify_distribution_and_consumption">3.1.7. Package roles in an Ansible collection to simplify distribution and consumption</a></li>
<li><a href="#_check_mode">3.1.8. Check Mode</a></li>
<li><a href="#_idempotency">3.1.9. Idempotency</a></li>
<li><a href="#_supporting_multiple_distributions_and_versions">3.1.10. Supporting multiple distributions and versions</a></li>
<li><a href="#_platform_specific_variables">3.1.11. Platform specific variables</a></li>
<li><a href="#_platform_specific_tasks">3.1.12. Platform specific tasks</a></li>
<li><a href="#_supporting_multiple_providers">3.1.13. Supporting multiple providers</a></li>
<li><a href="#_generating_files_from_templates">3.1.14. Generating files from templates</a></li>
<li><a href="#_vars_vs_defaults">3.1.15. Vars vs Defaults</a></li>
<li><a href="#_documentation_conventions">3.1.16. Documentation conventions</a></li>
<li><a href="#_create_a_meaningful_readme_file_for_every_role">3.1.17. Create a meaningful README file for every role</a></li>
<li><a href="#_dont_use_host_group_names_or_at_least_make_them_a_parameter">3.1.18. Don&#8217;t use host group names or at least make them a parameter</a></li>
<li><a href="#_prefix_task_names_in_sub_tasks_files_of_roles">3.1.19. Prefix task names in sub-tasks files of roles</a></li>
<li><a href="#_argument_validation">3.1.20. Argument Validation</a></li>
</ul>
</li>
<li><a href="#_references">3.2. References</a></li>
</ul>
</li>
<li><a href="#_collections_good_practices">4. Collections good practices</a>
<ul class="sectlevel2">
<li><a href="#_collection_structure_should_be_at_the_type_or_landscape_level">4.1. Collection Structure should be at the type or landscape level</a></li>
<li><a href="#_create_implicit_collection_variables_and_reference_them_in_your_roles_defaults_variables">4.2. Create implicit collection variables and reference them in your roles' defaults variables</a></li>
<li><a href="#_include_a_readme_file_in_each_collection">4.3. Include a README file in each collection</a></li>
<li><a href="#_include_a_license_file_in_a_collection_root_directory">4.4. Include a license file in a collection root directory</a></li>
</ul>
</li>
<li><a href="#_playbooks_good_practices">5. Playbooks good practices</a>
<ul class="sectlevel2">
<li><a href="#_keep_your_playbooks_as_simple_as_possible">5.1. Keep your playbooks as simple as possible</a></li>
<li><a href="#_use_either_the_tasks_or_roles_section_in_playbooks_not_both">5.2. Use either the tasks or roles section in playbooks, not both</a></li>
<li><a href="#_use_tags_cautiously_either_for_roles_or_for_complete_purposes">5.3. Use tags cautiously either for roles or for complete purposes</a></li>
<li><a href="#_use_the_verbosity_parameter_with_debug_statements">5.4. Use the verbosity parameter with debug statements</a></li>
</ul>
</li>
<li><a href="#_inventories_and_variables_good_practices_for_ansible">6. Inventories and Variables Good Practices for Ansible</a>
<ul class="sectlevel2">
<li><a href="#_identify_your_single_sources_of_truth_and_use_itthem_in_your_inventory">6.1. Identify your Single Source(s) of Truth and use it/them in your inventory</a></li>
<li><a href="#differentiate">6.2. Differentiate clearly between "As-Is" and "To-Be" information</a></li>
<li><a href="#_define_your_inventory_as_structured_directory_instead_of_single_file">6.3. Define your inventory as structured directory instead of single file</a></li>
<li><a href="#_rely_on_your_inventory_to_loop_over_hosts_dont_create_lists_of_hosts">6.4. Rely on your inventory to loop over hosts, don&#8217;t create lists of hosts</a></li>
<li><a href="#_restrict_your_usage_of_variable_types">6.5. Restrict your usage of variable types</a></li>
<li><a href="#_prefer_inventory_variables_over_extra_vars_to_describe_the_desired_state">6.6. Prefer inventory variables over extra vars to describe the desired state</a></li>
</ul>
</li>
<li><a href="#_plugins_good_practices">7. Plugins good practices</a>
<ul class="sectlevel2">
<li><a href="#_python_guidelines">7.1. Python Guidelines</a></li>
<li><a href="#_write_documentation_for_all_plugin_types">7.2. Write documentation for all plugin types</a></li>
<li><a href="#_use_sphinx_rest_formatted_docstrings_in_python_code">7.3. Use sphinx (reST) formatted docstrings in Python code</a></li>
<li><a href="#_use_python_type_hints_to_document_variable_types">7.4. Use Python type hints to document variable types.</a></li>
<li><a href="#_the_use_of_unittest_is_discouraged_use_pytest_instead">7.5. The use of unittest is discouraged, use pytest instead.</a></li>
<li><a href="#_formatting_of_manually_maintained_plugin_argspecs">7.6. Formatting of manually maintained plugin argspecs</a></li>
<li><a href="#_keep_plugin_entry_files_to_a_minimal_size">7.7. Keep plugin entry files to a minimal size.</a></li>
<li><a href="#_plugins_should_be_initially_developed_using_the_ansible_plugin_builder">7.8. Plugins should be initially developed using the ansible plugin builder</a></li>
<li><a href="#_use_clear_errorinfo_messages">7.9. Use clear error/info messages</a></li>
</ul>
</li>
<li><a href="#_coding_style_good_practices_for_ansible">8. Coding Style Good Practices for Ansible</a>
<ul class="sectlevel2">
<li><a href="#_naming_things">8.1. Naming things</a></li>
<li><a href="#_yaml_and_jinja2_syntax">8.2. YAML and Jinja2 Syntax</a></li>
<li><a href="#_ansible_guidelines">8.3. Ansible Guidelines</a></li>
<li><a href="#_wrap_longer_lines_of_code">8.4. Wrap longer lines of code</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://ansible.com/">Ansible</a> is simple, flexible, and powerful. Like any powerful tool, there are many ways to use it, some better than others.</p>
</div>
<div class="paragraph">
<p>This document aims to gather good practices from the field of Ansible practitioners at Red Hat, consultants, developers, and others.
And thus it strives to give any Red Hat employee, partner or customer (or any Ansible user) a guideline from which to start in good conditions their automation journey.</p>
</div>
<div class="paragraph">
<p>Those are opinionated guidelines based on the experience of many people.
They are not meant to be followed blindly if they don&#8217;t fit the reader&#8217;s specific use case, organization or needs;
there is a reason why they are called <em>good</em> and not <em>best</em> practices.</p>
</div>
<div class="paragraph">
<p>The reader of this document is expected to have working practice of Ansible.
If they are new to Ansible, the <a href="https://docs.ansible.com/ansible/latest/user_guide/index.html#getting-started">Getting started</a> section of
the <a href="https://docs.ansible.com/">official Ansible documentation</a> is a better place to start.</p>
</div>
<div class="paragraph">
<p>This document is split in six main sections.
Each section covers a different aspect of automation using Ansible (and in a broader term the whole <a href="https://www.redhat.com/en/technologies/management/ansible">Red Hat Ansible Automation Platform</a>, including Ansible Tower):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>structures: we need to know what to use for which purpose before we can delve into the details, this section explains this.</p>
</li>
<li>
<p>roles: as we recommend to use roles to host the most actual Ansible code, this is also where we&#8217;ll cover the more low level aspects of code (tasks, variables, etc&#8230;&#8203;).</p>
</li>
<li>
<p>collections</p>
</li>
<li>
<p>playbooks</p>
</li>
<li>
<p>inventories</p>
</li>
<li>
<p>plugins</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each section is then made of guidelines, one sentence hopefully easy to remember, followed by description, rationale and examples.
The HTML version of this document makes the content collapsable so that all guidelines can be seen at once in a very overseeable way, for the reader to uncollapse the content of guidelines they are interested in.</p>
</div>
<div class="paragraph">
<p>A rationale is expected for each good practice, with a reference if applicable.
It is really helpful to know not only how to do certain things, but why to do them in this way.
It will also help with further revisions of the standards as some items may become obsolete or no longer applicable.
If the reason is not included, there is a risk of keeping items that are no longer applicable, or alternatively blindly removing items that should be kept.
It also has great educational value for understanding how things actually work (or how they don&#8217;t).</p>
</div>
<div class="sect2">
<h3 id="_where_to_get_and_maintain_this_document">1.1. Where to get and maintain this document</h3>
<div class="paragraph">
<p>This document is published to <a href="https://redhat-cop.github.io/automation-good-practices/" class="bare">https://redhat-cop.github.io/automation-good-practices/</a>, it is open source and its source code is maintained at <a href="https://github.com/redhat-cop/automation-good-practices/" class="bare">https://github.com/redhat-cop/automation-good-practices/</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automation_structures">2. Automation structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we start to describe roles, playbooks, etc, we need to decide which one we use for what.
This section is meant for topics which span across multiple structures and don&#8217;t fit nicely within one.</p>
</div>
<div class="sect2">
<h3 id="_guiding_principles_for_automation_good_practices">2.1. Guiding principles for Automation Good Practices</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="paragraph">
<p>As an overall guiding principle for designing good automation, inspired by the <a href="https://peps.python.org/pep-0020/">Zen of Python, by Tim Peters</a>, the Zen of Ansible was created to serve as a guidepost to follow.
The principles defined in this are very applicable and can give guidance when the specific practice is unclear.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>The Zen of Ansible, by Tim Appnel

Ansible is not Python.
YAML sucks for coding.
Playbooks are not for programming.
Ansible users are (most probably) not programmers.
Clear is better than cluttered.
Concise is better than verbose.
Simple is better than complex.
Readability counts.
Helping users get things done matters most.
User experience beats ideological purity.
“Magic” conquers the manual.
When giving users options, always use convention over configuration.
Declarative is always better than imperative - most of the time.
Focus avoids complexity.
Complexity kills productivity.
If the implementation is hard to explain, it's a bad idea.
Every shell command and UI interaction is an opportunity to automate.
Just because something works, doesn't mean it can't be improved.
Friction should be eliminated whenever possible.
Automation is a continuous journey that never ends.</pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_define_which_structure_to_use_for_which_purpose">2.2. Define which structure to use for which purpose</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>define for which use case to use roles, playbooks, potentially workflows (in Ansible Controller/Tower/AWX), and how to split the code you write.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>especially when writing automation in a team, it is important to have a certain level of consistency and make sure everybody has the same understanding.
By lack of doing so, your automation becomes unreadable and difficult to grasp for new members or even for existing members.</p>
<div class="paragraph">
<p>Following a consistent structure will increase re-usability.
If one team member uses roles where another one uses playbooks, they will both struggle to reuse the code of each other.
Metaphorically speaking, only if stones have been cut at roughly the same size, can they be properly used to build a house.</p>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>The following is only one example of how to structure your content but has proven robust enough on multiple occasions.</p>
<div class="imageblock">
<div class="content">
<img src="images/ansible_structures.svg" alt="a hierarchy of landscape type function and component">
</div>
<div class="title">Figure 1. Structure of Automation</div>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>landscape</em> is anything you want to deploy at once, the underlay of your cloud, a three tiers application, a complete application cluster&#8230;&#8203;
This level is represented at best by a Controller/Tower/AWX workflow, potentially by a "playbook of playbooks", i.e. a playbook made of imported <em>type</em> playbooks, as introduced next.</p>
</li>
<li>
<p>a <em>type</em> must be defined such that each managed host has one and only one type, applicable using a unique playbook.</p>
</li>
<li>
<p>each type is then made of multiple <em>functions</em>, represented by roles, so that the same function used by the same <em>type</em> can be re-used, written only once.</p>
</li>
<li>
<p>and finally <em>components</em> are used to split a <em>function</em> in maintainable bits. By default a component is a task file within the <em>function</em>-role, if the role becomes too big, there is a case for splitting the <em>function</em> role into multiple <em>component</em> roles.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
if <em>functions</em> are defined mostly for re-usability purposes, <em>components</em> are more used for maintainability / readability purposes. A re-usable component might be a candidate for promotion to a function.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s have a more concrete example to clarify:</p>
</div>
</li>
<li>
<p>as already written, a <em>landscape</em> could be a three tier application with web-front-end, middleware and database.
We would probably create a workflow to deploy this landscape at once.</p>
</li>
<li>
<p>our types would be relatively obvious here as we would have "web-front-end server", "middleware server" and "database server".
Each type can be fully deployed by one and only one playbook (avoid having numbered playbooks and instructions on how to call them one after the other).</p>
</li>
<li>
<p>each server type is then made up of one or more <em>functions</em>, each implemented as a role.
For example, the middleware server type could be made of a "virtual machine" (to create the virtual machine hosting the middleware server), a "base Linux OS" and a "JBoss application server" function.</p>
</li>
<li>
<p>and then the base OS role could be made of multiple components (DNS, NTP, SSH, etc), each represented by a separate <code>tasks/{component}.yml</code> file, included or imported from the <code>tasks/main.yml</code> file of the <em>function</em>-role.
If a component becomes too big to fit within one task file, it might make sense that it gets its own component-role, included from the function-role.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
in terms of re-usability, see how you could simply create a new "integrated three tiers server" type (e.g. for test purposes), by just re-combining the "virtual machine", "base Linux OS", "JBoss application server", "PostgreSQL database" and "Apache web-server" function-roles into one new playbook.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Beware that those rules, once defined, shouldn&#8217;t be applied too strictly.
There can always be reasons for breaking the rules, and sometimes requires discussion with your team to decide what is more important.
For example if a "hardened Linux OS" and a "normal Linux OS" are two different functions, or the same function with different parameters. You could consider SSH to be a function on its own and not a component of the base OS.
Also, external re-usable roles and collections, obviously not respecting your rules, might force you to bend them.
Important is to break the rules not by ignorance of those but because of good and practical reasons.
Respecting the rules is to know and acknowledge them, not to follow them blindly even if they don&#8217;t make sense.
As long as exceptions are discussed openly in the team, they won&#8217;t hurt.</p>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_roles_good_practices_for_ansible">3. Roles Good Practices for Ansible</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
this section has been rewritten, using <a href="https://github.com/oasis-roles/meta_standards">OASIS metastandards repository</a> as a starting place. If you have anything to add or review, please comment.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_role_design_considerations">3.1. Role design considerations</h3>
<div class="sect3">
<h4 id="_basic_design">3.1.1. Basic design</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Design roles focused on the functionality provided, not the software implementation.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Try to design roles focused on the functionality, not on the software implementation behind it.
This will help abstracting differences between different providers, and help the user to focus on the functionality, not on technical details.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>For an example, designing a role to implement an NTP configuration on a server would be a role.
The role internally would have the logic to decide whether to use ntpd, chronyd, and the ntp site configurations.
However, when the underlying implementations become too divergent, for example implementing an email server with postfix or sendmail, then
separate roles are encouraged.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Design roles to accomplish a specific, guaranteed outcome and limit the scope of the role to that outcome.
This will help abstracting differences between different providers (see above), and help the user to focus on the functionality, not on technical details.</p>
</div>
</div>
</details>
<div class="ulist">
<ul>
<li>
<p>Design the interface focused on the functionality, not on the software implementation behind it.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Limit the consumer&#8217;s need to understand specific implementation details about a collection, the role names within, and the file names. Presenting the collection as a low-code/no-code "automation application" provides the developer flexibility as the content grows and matures, and limits change the consumer may have to make in a later version.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>In the first example, the <code>mycollection.run</code> role has been designed to be an entry-point for the execution of multiple roles.  <code>mycollection.run</code> provides a standard interface for the user, without exposing the details of the underlying automations.  The implementation details of <code>thing_1</code> and <code>thing_2</code> may be changed by the developer without impacting the user as long as the interface of <code>mycollection.run</code> does not change.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Listing 1. Do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Perform several actions</span>
    <span class="na">include_role</span><span class="pi">:</span> <span class="s">mycollection.run</span>
    <span class="na">vars</span><span class="pi">:</span>
      <span class="na">actions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">thing_1</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">thing_1_var_1</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">thing_1_var_2</span><span class="pi">:</span> <span class="m">2</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">thing_2</span>
        <span class="na">vars</span><span class="pi">:</span>
          <span class="na">thing_2_var_1</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">thing_2_var_2</span><span class="pi">:</span> <span class="m">2</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In this example, the user must maintain awareness of the structure of the <code>thing_1</code> and <code>thing_2</code> roles, and the order of operations necessary for these roles to be used together. If the implementation of these roles is changed, the user will need to modify their playbook.
.Don&#8217;t do this:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>- hosts: all
  gather_facts: false
  tasks:
  - name: Do thing_1
    include_role:
      name: mycollection.thing_1
      tasks_from: thing_1.yaml
      vars:
        thing_1_var_1: 1
        thing_1_var_2: 2
  - name: Do thing_2
    include_role:
      name: mycollection.thing_2
      tasks_from: thing_2.yaml
      vars:
        thing_2_var_1: 1
        thing_2_var_2: 2</pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Place content common to multiple roles in a single reusable role, "common" is a typical name for this role when roles are packaged in a collection. Author loosely coupled, hierarchical content.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Roles that have hard dependencies on external roles or variables have limited flexibility and increased risk that changes to the dependency will result in unexpected behavior or failures.
Coupling describes the degree of dependency between roles and variables that need to act in coordination.
Hierarchical content is an architectural approach to designing your content where individual roles have parent-child relationships in an overall tree structure</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_role_structure">3.1.2. Role Structure</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>New roles should be initiated in line, with the skeleton directory, which has standard boilerplate code for a Galaxy-compatible
Ansible role and some enforcement around these standards</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>A consistent file tree structure will help drive consistency and reusability across the entire environment.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_role_distribution">3.1.3. Role Distribution</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Use <a href="https://semver.org/">semantic versioning</a> for Git release tags.
Use 0.y.z before the role is declared stable (interface-wise).</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>There are some <a href="https://github.com/ansible/ansible/issues/67512">restrictions</a> for Ansible Galaxy and Automation Hub.
The versioning must be in strict X.Y.Z[ab][W] format, where X, Y, and Z are integers.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_naming_parameters">3.1.4. Naming parameters</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>All defaults and all arguments to a role should have a name that begins with the role name to help avoid collision with other names.
Avoid names like <code>packages</code> in favor of a name like <code>foo_packages</code>.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Ansible has no namespaces, doing so reduces the potential for conflicts and makes clear what role a given variable belongs to.)</p>
</dd>
</dl>
</div>
</li>
<li>
<p>Same argument applies for modules provided in the roles, they also need a <code>$ROLENAME_</code> prefix:
<code>foo_module</code>. While they are usually implementation details and not intended for direct use in playbooks, the unfortunate fact is that importing a role makes them available to the rest of the playbook and therefore creates opportunities for name collisions.</p>
</li>
<li>
<p>Moreover, internal variables (those that are not expected to be set by users) are to be prefixed by two underscores: <code>__foo_variable</code>.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>role variables, registered variables, custom facts are usually intended to be local to the role, but in reality are not local to the role - as such a concept does not exist, and pollute the global namespace.
Using the name of the role reduces the potential for name conflicts and using the underscores clearly marks the variables as internals and not part of the common interface.
The two underscores convention has prior art in some popular roles like
<a href="https://github.com/geerlingguy/ansible-role-apache/blob/f2b91ac84001db3fd4b43306a8f73f1a54f96f7d/vars/Debian.yml#L8">geerlingguy.ansible-role-apache</a>).
This includes variables set by set_fact and register, because they persist in the namespace after the role has finished!</p>
</dd>
</dl>
</div>
</li>
<li>
<p>Prefix all tags within a role with the role name or, alternatively, a "unique enough" but descriptive prefix.</p>
</li>
<li>
<p>Do not use dashes in role names. This will cause issues with collections.</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_providers">3.1.5. Providers</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="paragraph">
<p>When there are multiple implementations of the same functionality, we call them &#8220;providers&#8221;.
A role supporting multiple providers should have an input variable called <code>$ROLENAME_provider</code>.
If this variable is not defined, the role should detect the currently running provider on the system, and respect it.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>users can be surprised if the role changes the provider if they are running one already.
If there is no provider currently running, the role should select one according to the OS version.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>on RHEL 7, chrony should be selected as the provider of time synchronization, unless there is ntpd already running on the system, or user requests it specifically.
Chrony should be chosen on RHEL 8 as well, because it is the only provider available.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The role should set a variable or custom fact called <code>$ROLENAME_provider_os_default</code> to the appropriate default value for the given OS version.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>users may want to set all their managed systems to a consistent
state, regardless of the provider that has been used previously.
Setting <code>$ROLENAME_provider</code> would achieve it, but is suboptimal, because it requires selecting the appropriate value by the user, and if the user has multiple system versions managed by a single playbook, a common value supported by all of them may not even exist.
Moreover, after a major upgrade of their systems, it may force the users to change their playbooks to change their <code>$ROLENAME_provider</code> setting, if the previous value is not supported anymore.
Exporting <code>$ROLENAME_provider_os_default</code> allows the users to set <code>$ROLENAME_provider: "{{ $ROLENAME_provider_os_default }}"</code> (thanks to the lazy variable evaluation in Ansible) and thus get a consistent setting for all the systems of the given OS version without having to decide what the actual value is - the decision is delegated to the role).</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_distributions_and_versions">3.1.6. Distributions and Versions</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Avoid testing for distribution and version in tasks.
Rather add a variable file to "vars/" for each supported distribution and version with the variables that need to change according to the distribution and version.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>This way it is easy to add support to a new distribution by simply dropping a new file in to "vars/", see below <a href="#supporting-multiple-distributions-and-versions">Supporting multiple distributions and versions</a>.
See also <a href="#vars-vs-defaults">Vars vs Defaults</a> which mandates "Avoid embedding large lists or 'magic values' directly into the playbook."
Since distribution-specific values are kind of "magic values", it applies to them.
The same logic applies for providers: a role can load a provider-specific variable file, include a provider-specific task file, or both, as needed.
Consider making paths to templates internal variables if you need different templates for different distributions.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_package_roles_in_an_ansible_collection_to_simplify_distribution_and_consumption">3.1.7. Package roles in an Ansible collection to simplify distribution and consumption</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Packaging roles as a collection allows you to distribute many roles in a single cohesive unit of re-usable automation.
Inside a collection, you can share custom plugins across all roles in the collection instead of duplicating them in each role’s <code>library/</code> directory.
Collections give your roles a namespace, which removes the potential for naming collisions when developing new roles.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>See the Ansible documentation on <a href="https://docs.ansible.com/ansible/devel/dev_guide/migrating_roles.html">migrating roles to collections</a> for details.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_check_mode">3.1.8. Check Mode</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>The role should work in check mode, meaning that first of all, they should not fail check mode, and they should also not report changes when there are no changes to be done.
If it is not possible to support it, please state the fact and provide justification in the documentation.
This applies to the first run of the role.</p>
</li>
<li>
<p>Reporting changes properly is related to the other requirement: <strong>idempotency</strong>.
Roles should not perform changes when applied a second time to the same system with the same parameters, and it should not report that changes have been done if they have not been done.
Due to this, using <code>command:</code> is problematic, as it always reports changes.
Therefore, override the result by using <code>changed_when:</code></p>
</li>
<li>
<p>Concerning check mode, one usual obstacle to supporting it are registered variables.
If there is a task which registers a variable and this task does not get executed (e.g. because it is a <code>command:</code> or another task which is not properly idempotent), the variable will not get registered and further accesses to it will fail (or worse, use the previous value, if the role has been applied before in the play, because variables are global and there is no way to unregister them).
To fix, either use a properly idempotent module to obtain the information (e.g. instead of using <code>command: cat</code> to read file into a registered variable, use <code>slurp</code> and apply <code>.content|b64decode</code> to the result like <a href="https://github.com/linux-system-roles/kdump/pull/23/files#diff-d2414d4ec8ba189e1a244b0afc9aa81eL8">here</a>), or apply proper <code>check_mode:</code> and <code>changed_when:</code> attributes to the task.
<a href="https://github.com/ansible/molecule/issues/128#issue-135906202">more_info</a>.</p>
</li>
<li>
<p>Another problem are commands that you need to execute to make changes.
In check mode, you need to test for changes without actually applying them.
If the command has some kind of "--dry-run" flag to enable executing without making actual changes, use it in check_mode (use the variable <code>ansible_check_mode</code> to determine whether we are in check mode).
But you then need to set <code>changed_when:</code> according to the command status or output to indicate changes.
See (<a href="https://github.com/linux-system-roles/selinux/pull/38/files#diff-2444ad0870f91f17ca6c2a5e96b26823L101" class="bare">https://github.com/linux-system-roles/selinux/pull/38/files#diff-2444ad0870f91f17ca6c2a5e96b26823L101</a>) for an example.</p>
</li>
<li>
<p>Another problem is using commands that get installed during the install phase, which is skipped in check mode.
This will make check mode fail if the role has not been executed before (and the packages are not there), but does the right thing if check mode is executed after normal mode.</p>
</li>
<li>
<p>To view reasoning for supporting why check mode in first execution may not be worthwhile: see <a href="https://github.com/ansible/molecule/issues/128#issuecomment-245009843">here</a>.
If this is to be supported, see <a href="https://github.com/linux-system-roles/timesync/issues/27#issuecomment-472466223">hhaniel&#8217;s proposal</a>, which seems to properly guard even against such cases.</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_idempotency">3.1.9. Idempotency</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Reporting changes properly is related to the other requirement: <strong>idempotency</strong>. Roles should not perform changes when applied a second time to the same system with the same parameters, and it should not report that changes have been done if they have not been done. Due to this, using <code>command:</code> is problematic, as it always reports changes. Therefore, override the result by using <code>changed_when:</code></p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Additional automation or other integrations, such as with external ticketing systems, should rely on the idempotence of the ansible role to report changes accurately</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_supporting_multiple_distributions_and_versions">3.1.10. Supporting multiple distributions and versions</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Use Cases</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>The role developer needs to be able to set role variables to different values depending on the OS platform and version.  For example, if the name of a service is different between EL8 and EL9, or a config file location is different.</p>
</li>
<li>
<p>The role developer needs to handle the case where the user specifies <code>gather_facts: false</code> in the playbook.</p>
</li>
<li>
<p>The role developer needs to access the platform specific vars in role integration tests without making a copy.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The recommended solution below requires at least some <code>ansible_facts</code> to be defined, and so relies on gathering some facts.
If you just want to ensure the user always uses <code>gather_facts: true</code>, and do not want to handle this in the role, then the role documentation should state that <code>gather_facts: true</code> or <code>setup:</code> is required in order to use the role, and the role should use <code>fail:</code> with a descriptive error message if the necessary facts are not defined.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If it is desirable to use roles that require facts, but fact gathering is expensive, consider using a cache plugin <a href="https://docs.ansible.com/ansible/latest/collections/index_cache.html">List of Cache Plugins</a>, and also consider running a periodic job on the controller to refresh the cache.</p>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_platform_specific_variables">3.1.11. Platform specific variables</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>You normally use <code>vars/main.yml</code> (automatically included) to set variables used by your role.
If some variables need to be parameterized according to distribution and version (name of packages, configuration file paths, names of services), use this in the beginning of your <code>tasks/main.yml</code>:</p>
</dd>
<dt class="hdlist1">Examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure ansible_facts used by role</span>
  <span class="na">setup</span><span class="pi">:</span>
    <span class="na">gather_subset</span><span class="pi">:</span> <span class="s">min</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">not ansible_facts.keys() | list |</span>
    <span class="s">intersect(__rolename_required_facts) == __rolename_required_facts</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set platform/version specific variables</span>
  <span class="na">include_vars</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__rolename_vars_file</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">loop</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['os_family']</span><span class="nv"> </span><span class="s">}}.yml"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}.yml"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_major_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">__rolename_vars_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">role_path</span><span class="nv"> </span><span class="s">}}/vars/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">__rolename_vars_file is file</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add this as the first task in <code>tasks/main.yml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set platform/version specific variables</span>
  <span class="na">include_tasks</span><span class="pi">:</span> <span class="s">tasks/set_vars.yml</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add files to <code>vars/</code> for the required OS platforms and versions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The files in the <code>loop</code> are in order from least specific to most specific:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>os_family</code> covers a group of closely related platforms (e.g. <code>RedHat</code> covers RHEL, CentOS, Fedora)</p>
</li>
<li>
<p><code>distribution</code> (e.g. <code>Fedora</code>) is more specific than <code>os_family</code></p>
</li>
<li>
<p><code>distribution</code>_<code>distribution_major_version</code> (e.g. <code>RedHat_8</code>) is more specific than <code>distribution</code></p>
</li>
<li>
<p><code>distribution</code>_<code>distribution_version</code> (e.g. <code>RedHat_8.3</code>) is the most specific</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#ansible-facts-distribution">Commonly Used Facts</a> for an explanation of the facts and their common values.</p>
</div>
<div class="paragraph">
<p>Each file in the <code>loop</code> list will allow you to add or override variables to specialize the values for platform and/or version.
Using the <code>when: item is file</code> test means that you do not have to provide all of the <code>vars/</code> files, only the ones you need.
For example, if every platform except Fedora uses <code>srv_name</code> for the service name, you can define <code>myrole_service: srv_name</code> in <code>vars/main.yml</code> then define <code>myrole_service: srv2_name</code> in <code>vars/Fedora.yml</code>.
In cases where this would lead to duplicate vars files for similar distributions (e.g. CentOS 7 and RHEL 7), use symlinks to avoid the duplication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
With this setup, files can be loaded twice.
For example, on Fedora, the <code>distribution_major_version</code> is the same as <code>distribution_version</code> so the file <code>vars/Fedora_31.yml</code> will be loaded twice if you are managing a Fedora 31 host.
If <code>distribution</code> is <code>RedHat</code> then <code>os_family</code> will also be <code>RedHat</code>, and <code>vars/RedHat.yml</code> will be loaded twice.
This is usually not a problem - you will be replacing the variable with the same value, and the performance hit is negligible.
If this is a problem, construct the file list as a list variable, and filter the variable passed to <code>loop</code> using the <code>unique</code> filter (which preserves the order):
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set vars file list</span>
  <span class="na">set_fact</span><span class="pi">:</span>
    <span class="na">__rolename_vars_file_list</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['os_family']</span><span class="nv"> </span><span class="s">}}.yml"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}.yml"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_major_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set platform/version specific variables</span>
  <span class="na">include_vars</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__rolename_vars_file</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">loop</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__rolename_vars_file_list</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">unique</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">__rolename_vars_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">role_path</span><span class="nv"> </span><span class="s">}}/vars/{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">__rolename_vars_file is file</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or define your <code>__rolename_vars_file_list</code> in your <code>vars/main.yml</code>.</p>
</div>
<div class="paragraph">
<p>The task <code>Ensure ansible_facts used by role</code> handles the case where the user specifies <code>gather_facts: false</code> in the playbook.
It gathers <strong>only</strong> the facts required by the role.
The role developer may need to add additional facts to the list, and use a different <code>gather_subset</code>.
See <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html#setup-module">Setup Module</a> for more information.
Gathering facts can be expensive, so gather <strong>only</strong> the facts required by the role.</p>
</div>
<div class="paragraph">
<p>Using a separate task file for <code>tasks/set_vars.yml</code> allows role integration tests to access the internal variables.
For example, if the role developer wants to pre-populate a VM with the packages used by the role, the following tasks can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set platform/version specific variables</span>
      <span class="na">include_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">my.fqcn.rolename</span>
        <span class="na">tasks_from</span><span class="pi">:</span> <span class="s">set_vars.yml</span>
        <span class="na">public</span><span class="pi">:</span> <span class="kc">true</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install test packages</span>
      <span class="na">package</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__rolename_packages</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">present</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this way, the role developer does not have to copy and maintain a separate list of role packages.</p>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_platform_specific_tasks">3.1.12. Platform specific tasks</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="paragraph">
<p>Platform specific tasks, however, are different.
You probably want to perform platform specific tasks once, for the most specific match.
In that case, use <code>lookup('first_found')</code> with the file list in order of most specific to least specific, including a "default":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Perform platform/version specific tasks</span>
  <span class="na">include_tasks</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">lookup('first_found',</span><span class="nv"> </span><span class="s">__rolename_ff_params)</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">__rolename_ff_params</span><span class="pi">:</span>
      <span class="na">files</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_major_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}.yml"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['os_family']</span><span class="nv"> </span><span class="s">}}.yml"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">default.yml"</span>
      <span class="na">paths</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">role_path</span><span class="nv"> </span><span class="s">}}/tasks/setup"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you would provide <code>tasks/setup/default.yml</code> to do the generic setup, and e.g. <code>tasks/setup/Fedora.yml</code> to do the Fedora specific setup.
The <code>tasks/setup/default.yml</code> is required in order to use <code>lookup('first_found')</code>, which will give an error if no file is found.</p>
</div>
<div class="paragraph">
<p>If you want to have the "use first file found" semantics, but do not want to have to provide a default file, add <code>skip: true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Perform platform/version specific tasks</span>
  <span class="na">include_tasks</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">lookup('first_found',</span><span class="nv"> </span><span class="s">__rolename_ff_params)</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">__rolename_ff_params</span><span class="pi">:</span>
      <span class="na">files</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution']</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">ansible_facts['distribution_version']</span><span class="nv"> </span><span class="s">}}.yml"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">ansible_facts['os_family']</span><span class="nv"> </span><span class="s">}}.yml"</span>
      <span class="na">paths</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">role_path</span><span class="nv"> </span><span class="s">}}/tasks/setup"</span>
      <span class="na">skip</span><span class="pi">:</span> <span class="kc">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>NOTE</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>include_tasks</code> or <code>include_vars</code> with <code>lookup('first_found')</code> instead of <code>with_first_found</code>.
<code>loop</code> is not needed - the include forms take a string or a list directly.</p>
</li>
<li>
<p>Always specify the explicit, absolute path to the files to be included,
using <code>{{ role_path }}/vars</code> or <code>{{ role_path }}/tasks</code>, when using these
idioms.
  See below "Ansible Best Practices" for more information.</p>
</li>
<li>
<p>Use the <code>ansible_facts['name']</code> bracket notation rather than the <code>ansible_facts.name</code> or <code>ansible_name</code> form.
For example, use <code>ansible_facts['distribution']</code> instead of <code>ansible_distribution</code> or <code>ansible.distribution</code>.
The <code>ansible_name</code> form relies on fact injection, which can break if there is already a fact of that name.
Also, the bracket notation is what is used in Ansible documentation such as <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#ansible-facts-distribution">Commonly Used Facts</a> and <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#operating-system-and-distribution-variance">Operating System and Distribution Variance</a>.</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_supporting_multiple_providers">3.1.13. Supporting multiple providers</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="paragraph">
<p>Use a task file per provider and include it from the main task file, like this example from <code>storage:</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">include the appropriate provider tasks</span>
  <span class="na">include_tasks</span><span class="pi">:</span> <span class="s2">"</span><span class="s">main_{{</span><span class="nv"> </span><span class="s">storage_provider</span><span class="nv"> </span><span class="s">}}.yml"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same process should be used for variables (not defaults, as defaults can
not be loaded according to a variable).
You should guarantee that a file exists for each provider supported, or use an explicit, absolute path using <code>role_path</code>.
See below "Ansible Best Practices" for more information.</p>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_generating_files_from_templates">3.1.14. Generating files from templates</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Add <code>{{ ansible_managed | comment }}</code> at the top of the template file to indicate that the file is managed by Ansible roles, while making sure that multi-line values are properly commented.
For more information, see <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#adding-comments-to-files">Adding comments to files</a>.</p>
</li>
<li>
<p>When commenting, don&#8217;t include anything like "Last modified: {{ date }}".
This would change the file at every application of the role, even if it doesn&#8217;t need to be changed for other reasons, and thus break proper change reporting.</p>
</li>
<li>
<p>Use standard module parameters for backups, keep it on unconditionally (<code>backup: true</code>), until there is a user request to have it configurable.</p>
</li>
<li>
<p>Make prominently clear in the HOWTO (at the top) what settings/configuration files are replaced by the role instead of just modified.</p>
</li>
<li>
<p>Use <code>{{ role_path }}/subdir/</code> as the filename prefix when including files if the name has a variable in it.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>your role may be included by another role, and if you specify a relative path, the file could be found in the including role.
For example, if you have something like <code>include_vars: "{{ ansible_facts['distribution'] }}.yml"</code> and you do not provide every possible <code>vars/{{ ansible_facts['distribution'] }}.yml</code> in your role, Ansible will look in the including role for this file.
Instead, to ensure that only your role will be referenced, use <code>include_vars: "{{role_path}}/vars/{{ ansible_facts['distribution'] }}.yml"</code>.
Same with other file based includes such as <code>include_tasks</code>.
See <a href="https://docs.ansible.com/ansible/latest/dev_guide/overview_architecture.html#the-ansible-search-path">Ansible Developer Guide » Ansible architecture » The Ansible Search Path</a> for more information.</p>
</dd>
</dl>
</div>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_vars_vs_defaults">3.1.15. Vars vs Defaults</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Avoid embedding large lists or "magic values" directly into the playbook.
Such static lists should be placed into the <code>vars/main.yml</code> file and named appropriately</p>
</li>
<li>
<p>Every argument accepted from outside of the role should be given a default value in <code>defaults/main.yml</code>.
This allows a single place for users to look to see what inputs are expected.
Document these variables in the role&#8217;s README.md file copiously</p>
</li>
<li>
<p>Use the <code>defaults/main.yml</code> file in order to avoid use of the default Jinja2 filter within a playbook.
Using the default filter is fine for optional keys on a dictionary, but the variable itself should be defined in <code>defaults/main.yml</code> so that it can have documentation written about it there and so that all arguments can easily be located and identified.</p>
</li>
<li>
<p>Don&#8217;t define defaults in <code>defaults/main.yml</code> if there is no meaningful default.
It is better to have the role fail if the variable isn&#8217;t defined than have it do something dangerously wrong.
Still do add the variable to <code>defaults/main.yml</code> but <em>commented out</em>, so that there is one single source of input variables.</p>
</li>
<li>
<p>Avoid giving default values in <code>vars/main.yml</code> as such values are very high in the precedence order and are difficult for users and consumers of a role to override.</p>
</li>
<li>
<p>As an example, if a role requires a large number of packages to install, but could also accept a list of additional packages, then the required packages should be placed in <code>vars/main.yml</code> with a name such as <code>foo_packages</code>, and the extra packages should be passed in a variable named <code>foo_extra_packages</code>, which should default to an empty array in <code>defaults/main.yml</code> and be documented as such.</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_documentation_conventions">3.1.16. Documentation conventions</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Use fully qualified role names in examples, like: <code>linux-system-roles.$ROLENAME</code> (with the Galaxy prefix).</p>
</li>
<li>
<p>Use RFC <a href="https://tools.ietf.org/html/rfc5737">5737</a>, <a href="https://tools.ietf.org/html/rfc7042#section-2.1.1">7042</a> and <a href="https://tools.ietf.org/html/rfc3849">3849</a> addresses in examples.</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_create_a_meaningful_readme_file_for_every_role">3.1.17. Create a meaningful README file for every role</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>The documentation is essential for the success of the content.
Place the README file in the root directory of the role.
The README file exists to introduce the user to the purpose of the role and any important information on how to use it, such as credentials that are required.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>At minimum include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Example playbooks that allow users to understand how the developed content works are also part of the documentation.</p>
</li>
<li>
<p>The inbound and outbound role argument specifications</p>
</li>
<li>
<p>List of user-facing capabilities within the role</p>
</li>
<li>
<p>The unit of automation the role provides</p>
</li>
<li>
<p>The outcome of the role</p>
</li>
<li>
<p>The roll-back capabilities of the role</p>
</li>
<li>
<p>Designation of the role as idempotent (True/False)</p>
</li>
<li>
<p>Designation of the role as atomic if applicable (True/False)</p>
</li>
</ul>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_dont_use_host_group_names_or_at_least_make_them_a_parameter">3.1.18. Don&#8217;t use host group names or at least make them a parameter</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>It is relatively common to use (inventory) group names in roles:</p>
<div class="ulist">
<ul>
<li>
<p>either to loop through the hosts in the group, generally in a cluster context</p>
</li>
<li>
<p>or to validate that a host is in a specific group</p>
<div class="paragraph">
<p>Instead, store the host name(s) in a (list) variable, or at least make the group name a parameter of your role.
You can always set the variable at group level to avoid repetitions.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Groups are a feature of the data in your inventory, meaning that you mingle data with code when you use those groups in your code.
Rely on the inventory-parsing process to provide your code with the variables it needs instead of enforcing a specific structure of the inventory.
Not all inventory sources are flexible enough to provide exactly the expected group name.
Even more importantly, in a cluster context for example, if the group name is fixed, you can&#8217;t describe (and hence automate) more than one cluster in each inventory.
You can&#8217;t possibly have multiple groups with the same name in the same inventory.
On the other hand, variables can have any kind of value for each host, so that you can have as many clusters as you want.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Assuming we have the following inventory (not according to recommended practices for sake of simplicity):</p>
<div class="listingblock">
<div class="title">Listing 2. An inventory with two clusters</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[cluster_group_A]</span>
<span class="err">host1</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>
<span class="err">host2</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>
<span class="err">host3</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>

<span class="nn">[cluster_group_B]</span>
<span class="err">host4</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>
<span class="err">host5</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>
<span class="err">host6</span> <span class="py">ansible_host</span><span class="p">=</span><span class="s">localhost</span>

<span class="nn">[cluster_group_A:vars]</span>
<span class="py">cluster_group_name</span><span class="p">=</span><span class="s">cluster_group_A</span>

<span class="nn">[cluster_group_B:vars]</span>
<span class="py">cluster_group_name</span><span class="p">=</span><span class="s">cluster_group_B</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then use one of the following three approaches in our role (here as playbook, again for sake of simplicity):</p>
</div>
<div class="listingblock">
<div class="title">Listing 3. A playbook showing how to loop through a group</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Show how to loop through a set of groups</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">cluster_group_?</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">The loop happens for each host, might be too much</span>
      <span class="na">ansible.builtin.debug</span><span class="pi">:</span>
        <span class="na">msg</span><span class="pi">:</span> <span class="s">do something with {{ item }}</span>
      <span class="na">loop</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">groups[cluster_group_name]</span><span class="nv"> </span><span class="s">}}"</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">The loop happens only for the first host in each group</span>
      <span class="na">ansible.builtin.debug</span><span class="pi">:</span>
        <span class="na">msg</span><span class="pi">:</span> <span class="s">do something with {{ item }}</span>
      <span class="na">loop</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">groups[cluster_group_name]</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">when</span><span class="pi">:</span> <span class="s">inventory_hostname == groups[cluster_group_name][0]</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Make the first host of each group fail to simulate non-availability</span>
      <span class="na">ansible.builtin.assert</span><span class="pi">:</span>
        <span class="na">that</span><span class="pi">:</span> <span class="s">inventory_hostname != groups[cluster_group_name][0]</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">The loop happens only for the first _available_ host in each group</span>
      <span class="na">ansible.builtin.debug</span><span class="pi">:</span>
        <span class="na">msg</span><span class="pi">:</span> <span class="s">do something with {{ item }}</span>
      <span class="na">loop</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">groups[cluster_group_name]</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">when</span><span class="pi">:</span> <span class="pi">&gt;-</span>
        <span class="s">inventory_hostname == (groups[cluster_group_name]</span>
        <span class="s">| intersect(ansible_play_hosts))[0]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first approach is probably best to create a cluster configuration file listing all cluster&#8217;s hosts.
The other approaches are good to make sure each action is performed only once, but this comes at the price of many skips.
The second one fails if the first host isn&#8217;t reachable (which might be what you&#8217;d want anyway), and the last one has the best chance to be executed once and only once, even if some hosts aren&#8217;t available.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
the variable <code>cluster_group_name</code> could have a default group name value in your role, of course properly documented, for simple use cases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Overall, it is best to avoid this kind of constructs if the use case permits, as they are clumsy.</p>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_prefix_task_names_in_sub_tasks_files_of_roles">3.1.19. Prefix task names in sub-tasks files of roles</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>It is a common practice to have <code>tasks/main.yml</code> file including other tasks files, which we&#8217;ll call sub-tasks files.
Make sure that the tasks' names in these sub-tasks files are prefixed with a shortcut reminding of the sub-tasks file&#8217;s name.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Especially in a complex role with multiple (sub-)tasks file, it becomes difficult to understand which task belongs to which file.
Adding a prefix, in combination with the role&#8217;s name automatically added by Ansible, makes it a lot easier to follow and troubleshoot a role play.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>In a role with one <code>tasks/main.yml</code> task file, including <code>tasks/sub.yml</code>, the tasks in this last file would be named as follows:</p>
<div class="listingblock">
<div class="title">Listing 4. A prefixed task in a sub-tasks file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sub | Some task description</span>
  <span class="na">mytask</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The log output will then look something like <code>TASK [myrole : sub | Some task description] <strong>*</strong>*</code>, which makes it very clear where the task is coming from.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
with a verbosity of 2 or more, ansible-playbook will show the full path to the task file, but this generally means that you need to restart the play in a higher verbosity to get the information you could have had readily available.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect3">
<h4 id="_argument_validation">3.1.20. Argument Validation</h4>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Starting from ansible version 2.11, an option is available to activate argument validation for roles by utilizing an argument specification.
When this specification is established, a task is introduced at the onset of role execution to validate the parameters provided for the role according to the defined specification.
If the parameters do not pass the validation, the role execution will terminate.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Argument validation significantly contributes to the stability and reliability of the automation.
It also makes the playbook using the role fail fast instead of failing later when an incorrect variable is utilized.
By ensuring roles receive accurate input data and mitigating common issues, we can enhance the effectiveness of the Ansible playbooks using the roles.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>The specification is defined in the meta/argument_specs.yml. For more details on how to write the specification, refer to <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html#specification-format" class="bare">https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html#specification-format</a>.</p>
<div class="listingblock">
<div class="title">Listing 5. Argument Specification file that validates the arguments provided to the role.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">argument_specs</span><span class="pi">:</span>
  <span class="na">main</span><span class="pi">:</span>
    <span class="na">short_description</span><span class="pi">:</span> <span class="s">Role description.</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">string_arg1</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">string argument description.</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">str"</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">x"</span>
        <span class="na">choices</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">x"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">y"</span><span class="pi">]</span>
      <span class="na">dict_arg1</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">dict argument description.</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">dict</span>
        <span class="na">required</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">options</span><span class="pi">:</span>
          <span class="na">key1</span><span class="pi">:</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s">key1 description.</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">int</span>
          <span class="na">key2</span><span class="pi">:</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s">key2 description.</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">str</span>
          <span class="na">key3</span><span class="pi">:</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s">key3 description.</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">dict</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
</div>
<div class="sect2">
<h3 id="_references">3.2. References</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="paragraph">
<p>Links that contain additional standardization information that provide context,
inspiration or contrast to the standards described above.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/debops/debops/blob/v0.7.2/docs/debops-policy/code-standards-policy.rst" class="bare">https://github.com/debops/debops/blob/v0.7.2/docs/debops-policy/code-standards-policy.rst</a>).
For inspiration, as the DebOps project has some specific guidance that we do not necessarily want to follow.</p>
</li>
<li>
<p><a href="https://adfinis.github.io/ansible-guide/styling_guide.html" class="bare">https://adfinis.github.io/ansible-guide/styling_guide.html</a></p>
</li>
<li>
<p><a href="https://docs.openstack.org/openstack-ansible/latest/contributors/code-rules.html#general-guidelines-for-submitting-code" class="bare">https://docs.openstack.org/openstack-ansible/latest/contributors/code-rules.html#general-guidelines-for-submitting-code</a></p>
</li>
</ul>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collections_good_practices">4. Collections good practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Note: Unreviewed work. Please contribute to the discussion in the Automation Red Hat COP</p>
</div>
<div class="sect2">
<h3 id="_collection_structure_should_be_at_the_type_or_landscape_level">4.1. Collection Structure should be at the type or landscape level</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Collections should be comprised of roles collected either at the type or landscape level. See <a href="#_define_which_structure_to_use_for_which_purpose">The Structures Definition</a></p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Gathering and publishing collections, rather than individual roles, allows for easier distribution and particularly becomes more important when we discuss Execution Environments.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_create_implicit_collection_variables_and_reference_them_in_your_roles_defaults_variables">4.2. Create implicit collection variables and reference them in your roles' defaults variables</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Often, variables will want to be defined on a collection level, but this can cause issues with roles being able to be reused.
By defining collection wide variables and referencing them in roles' defaults variables, this can be made clear and roles can remain reusable.
Collection variables are nowhere defined explicitly and are to be documented in the collection&#8217;s documentation.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Variables that are shared across collections can cause collisions when roles are reused outside of the original collection.
Role variables should continue to be named according to our <a href="#naming-things">recommendations for naming variables</a>
It still remains possible to overwrite collection variable values for a specific role.
Each role has it&#8217;s own set of defaults for the variable.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>For a collection "mycollection", two roles exist. "alpha" and "beta".  For this example, there is no default for the controller_username
and would have to be defined in one&#8217;s inventory. The no_log variable does have defaults defined, and thus only needs to be defined if the default
is being overwritten.</p>
<div class="listingblock">
<div class="title">Listing 6. Alpha defaults/main.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="c1"># specific role variables</span>
<span class="na">alpha_job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">some</span><span class="nv"> </span><span class="s">text'</span>
<span class="c1"># collection wide variables</span>
<span class="na">alpha_controller_username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">mycollection_controller_username</span><span class="nv"> </span><span class="s">}}"</span>
<span class="na">alpha_no_log</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">mycollection_no_log</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('true')</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 7. Beta defaults/main.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="c1"># specific role variables</span>
<span class="na">beta_job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">some</span><span class="nv"> </span><span class="s">other</span><span class="nv"> </span><span class="s">text'</span>
<span class="c1"># collection wide variables</span>
<span class="na">beta_controller_username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">mycollection_controller_username</span><span class="nv"> </span><span class="s">}}"</span>
<span class="na">beta_no_log</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">mycollection_no_log</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default('false')</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_include_a_readme_file_in_each_collection">4.3. Include a README file in each collection</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Include a README file that is in the root of the collection and which contains:</p>
<div class="ulist">
<ul>
<li>
<p>Information about the purpose of the collection</p>
</li>
<li>
<p>A link to the collection license file</p>
</li>
<li>
<p>General usage information such as which versions of ansible-core are supported and any libraries or SDKs which are required by the collection</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generating the README&#8217;s plugin documentation from the plugin code helps eliminate documentation errors.
Supplemental documentation such as user guides may be written in reStructured Text (rst) and located in the docs/docsite/rst/ directory of the collection.</p>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Use <a href="https://github.com/ansible-network/collection_prep" class="bare">https://github.com/ansible-network/collection_prep</a> to generate the documentation for the collection</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_include_a_license_file_in_a_collection_root_directory">4.4. Include a license file in a collection root directory</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Include a license file in the root directory
Name the license file either LICENSE or COPYING.
The contents may be either the text of the applicable license, or a link to the canonical reference for the license on the Internet (such as <a href="https://opensource.org/licenses/BSD-2-Clause" class="bare">https://opensource.org/licenses/BSD-2-Clause</a> )
If any file in the collection is licensed differently from the larger collection it is a part of (such as module utilities), note the applicable license in the header of the file.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_playbooks_good_practices">5. Playbooks good practices</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_keep_your_playbooks_as_simple_as_possible">5.1. Keep your playbooks as simple as possible</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Don&#8217;t put too much logic in your playbook, put it in your roles (or even in custom modules), and try to limit your playbooks to a list of a roles.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Roles are meant to be re-used and the structure helps you to make your code re-usable.
The more code you put in roles, the higher the chances you, or others, can reuse it.
Also, if you follow the <a href="#_define_which_structure_to_use_for_which_purpose">type-function pattern</a>, you can very easily create new (type) playbooks by just re-shuffling the roles.
This way you can create a playbook for each purpose without having to duplicate a lot of code.
This, in turn, also helps with the maintainability as there is only a single place where necessary changes need to be implemented, and that is in the role</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="listingblock">
<div class="title">Listing 8. An example of playbook containing only roles</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">A playbook can solely be a list of roles</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">role1</span>
    <span class="pi">-</span> <span class="s">role2</span>
    <span class="pi">-</span> <span class="s">role3</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
we&#8217;ll explain later why there might be a case for using <code>include_role</code>/<code>import_role</code> tasks instead of the role section.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_either_the_tasks_or_roles_section_in_playbooks_not_both">5.2. Use either the tasks or roles section in playbooks, not both</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>A playbook can contain <code>pre_tasks</code>, <code>roles</code>, <code>tasks</code> and <code>post_tasks</code> sections.
Avoid using both <code>roles</code> and <code>tasks</code> sections, the latter possibly containing <code>import_role</code> or <code>include_role</code> tasks.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>The order of execution between <code>roles</code> and <code>tasks</code> isn&#8217;t obvious, and hence mixing them should be avoided.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Either you need only static importing of roles and you can use the <code>roles</code> section, or you need dynamic inclusion and you should use <em>only</em> the <code>tasks</code> section.
Of course, for very simple cases, you can just use <code>tasks</code> without <code>roles</code>.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_tags_cautiously_either_for_roles_or_for_complete_purposes">5.3. Use tags cautiously either for roles or for complete purposes</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>limit your usage of tags to two aspects:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>either tags called like the roles to switch on/off single roles,</p>
</li>
<li>
<p>or specific tags to reach a meaningful purpose</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Don&#8217;t set tags which can&#8217;t be used on their own, or can be destructive if used on their own.</p>
</div>
<div class="paragraph">
<p>Also document tags and their purpose(s).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>there is nothing worse than tags which can&#8217;t be used alone, they bear the risk to destroy something by being called standalone.
An acceptable exception is the pattern to use the role name as tag name, which can be useful while developing the playbook to test, or exclude, individual roles.</p>
<div class="paragraph">
<p>Important is that your users don&#8217;t need to learn the right sequence of tags necessary to get a meaningful result, one tag should be enough.</p>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="listingblock">
<div class="title">Listing 9. An example of playbook importing roles with tags</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">A playbook can be a list of roles imported with tags</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Import role1</span>
      <span class="na">ansible.builtin.import_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role1</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role1</span>
        <span class="pi">-</span> <span class="s">deploy</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Import role2</span>
      <span class="na">ansible.builtin.import_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role2</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role2</span>
        <span class="pi">-</span> <span class="s">deploy</span>
        <span class="pi">-</span> <span class="s">configure</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Import role3</span>
      <span class="na">ansible.builtin.import_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role3</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role3</span>
        <span class="pi">-</span> <span class="s">configure</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You see that each role can be skipped/run individually, but also that the tags <code>deploy</code> and <code>configure</code> can be used to do something we&#8217;ll assume to be meaningful, without having to explain at length what they do.</p>
</div>
<div class="paragraph">
<p>The same approach is also possible with <code>include_role</code> but requires additionally to <code>apply</code> the same tags to the role&#8217;s tasks, which doesn&#8217;t make the code easier to read:</p>
</div>
<div class="listingblock">
<div class="title">Listing 10. An example of playbook including roles with tags</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">a playbook can be a list of roles included with tags applied</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>

  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">include role1</span>
      <span class="na">include_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role1</span>
        <span class="na">apply</span><span class="pi">:</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">role1</span>
            <span class="pi">-</span> <span class="s">deploy</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role1</span>
        <span class="pi">-</span> <span class="s">deploy</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">include role2</span>
      <span class="na">include_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role2</span>
        <span class="na">apply</span><span class="pi">:</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">role2</span>
            <span class="pi">-</span> <span class="s">deploy</span>
            <span class="pi">-</span> <span class="s">configure</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role2</span>
        <span class="pi">-</span> <span class="s">deploy</span>
        <span class="pi">-</span> <span class="s">configure</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">include role3</span>
      <span class="na">include_role</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">role3</span>
        <span class="na">apply</span><span class="pi">:</span>
          <span class="na">tags</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">role3</span>
            <span class="pi">-</span> <span class="s">configure</span>
      <span class="na">tags</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">role3</span>
        <span class="pi">-</span> <span class="s">configure</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_the_verbosity_parameter_with_debug_statements">5.4. Use the verbosity parameter with debug statements</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Debug messages should have a verbosity defined as appropriate for the message.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Debug messages are useful during testing and development, and can be useful to retain as playbooks go into production for future troubleshooting.
However, log messages will clutter your output, which can confuse users with non-relevant information.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="listingblock">
<div class="title">Listing 11. Adding verbosity to debug messages</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">don't make messages always display</span>
  <span class="na">debug</span><span class="pi">:</span>
    <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">This</span><span class="nv"> </span><span class="s">message</span><span class="nv"> </span><span class="s">will</span><span class="nv"> </span><span class="s">clutter</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">log</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">production"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">this message will only appear when verbosity is 2 or more</span>
  <span class="na">debug</span><span class="pi">:</span>
    <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Some</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">debug</span><span class="nv"> </span><span class="s">information</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">needed"</span>
    <span class="na">verbosity</span><span class="pi">:</span> <span class="s">2</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_inventories_and_variables_good_practices_for_ansible">6. Inventories and Variables Good Practices for Ansible</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_identify_your_single_sources_of_truth_and_use_itthem_in_your_inventory">6.1. Identify your Single Source(s) of Truth and use it/them in your inventory</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>A Single Source of Truth (SSOT) is the place where the "ultimate" truth about a certain data is generated, stored and maintained.
There can be more than one SSOT, each for a different piece of information, but they shouldn&#8217;t overlap and even less conflict.
As you create your inventory, you identify these SSOTs and combine them into one inventory using dynamic inventory sources (we&#8217;ll see how later on).
Only the aspects which are not already provided by other sources are kept statically in your inventory.
Doing this, your inventory becomes another source of truth, but only for the data it holds statically, because there is no other place to keep it.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>You limit your effort to maintain your inventory to its absolute minimum and you avoid generating potentially conflicting information with the rest of your IT.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>You can typically identify three kinds of candidates as SSOTs:</p>
<div class="ulist">
<ul>
<li>
<p>technical ones, where your managed devices live anyway, like a cloud or virtual manager (OpenStack, RHV, Public Cloud API, &#8230;&#8203;) or management systems (Satellite, monitoring systems, &#8230;&#8203;). Those sources provide you with technical information like IP addresses, OS type, etc.</p>
</li>
<li>
<p>managed ones, like a Configuration Management Database (CMDB), where your IT anyway manages a lot of information of use in an inventory. A CMDB provides you with more organizational information, like owner or location, but also with "to-be" technical information.</p>
</li>
<li>
<p>the inventory itself, only for the data which doesn&#8217;t exist anywhere else.</p>
<div class="paragraph">
<p>Ansible provides a lot of <a href="https://docs.ansible.com/ansible/latest/plugins/inventory.html">inventory plugins</a> to pull data from those sources and they can be combined into one big inventory.
This gives you a complete model of the environment to be automated, with limited effort to maintain it, and no confusion about where to modify it to get the result you need.</p>
</div>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="differentiate">6.2. Differentiate clearly between "As-Is" and "To-Be" information</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>As you combine multiple sources, some will represent:</p>
<div class="ulist">
<ul>
<li>
<p>discovered information grabbed from the existing environment, this is the "As-Is" information.</p>
</li>
<li>
<p>managed information entered in a tool, expressing the state to be reached, hence the "To-Be" information.</p>
<div class="paragraph">
<p>In general, the focus of an inventory is on the managed information because it represents the desired state you want to reach with your automation. This said, some discovered information is required for the automation to work.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Mixing up these two kind of information can lead to your automation taking the wrong course of action by thinking that the current situation is aligned with the desired state.
That can make your automation go awry and your automation engineers confused.
There is a reason why Ansible makes the difference between "facts" (As-Is) and "variables" (To-Be), and so should you.
In the end, automation is making sure that the As-Is situation complies to the To-Be description.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
many CMDBs have failed because they don&#8217;t respect this principle.
This and the lack of automation leads to a mix of unmaintained As-Is and To-Be information with no clear guideline on how to keep them up-to-date, and no real motivation to do so.
</td>
</tr>
</table>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>The technical tools typically contain a lot of discovered information, like an IP address or the RAM size of a VM.
In a typical cloud environment, the IP address isn&#8217;t part of the desired state, it is assigned on the fly by the cloud management layer, so you can only get it dynamically from the cloud API and you won&#8217;t manage it.
In a more traditional environment nevertheless, the IP address will be static, managed more or less manually, so it will become part of your desired state.
In this case, you shouldn&#8217;t use the discovered information or you might not realize that there is a discrepancy between As-Is and To-Be.</p>
<div class="paragraph">
<p>The RAM size of a VM will be always present in two flavours, e.g. As-Is coming from the technical source and To-Be coming from the CMDB, or your static inventory, and you shouldn&#8217;t confuse them.
By lack of doing so, your automation might not correct the size of the VM where it should have aligned the As-Is with the To-Be.</p>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_define_your_inventory_as_structured_directory_instead_of_single_file">6.3. Define your inventory as structured directory instead of single file</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Everybody has started with a single file inventory in ini-format (the courageous ones among us in YAML format), combining list of hosts, groups and variables.
An inventory can nevertheless be also a directory containing:</p>
<div class="ulist">
<ul>
<li>
<p>list(s) of hosts</p>
</li>
<li>
<p>list(s) of groups, with sub-groups and hosts belonging to those groups</p>
</li>
<li>
<p>dynamic inventory plug-ins configuration files</p>
</li>
<li>
<p>dynamic inventory scripts (deprecated but still simple to use)</p>
</li>
<li>
<p>structured <code>host_vars</code> directories</p>
</li>
<li>
<p>structured <code>group_vars</code> directories</p>
<div class="paragraph">
<p>The recommendation is to start with such a structure and extend it step by step.</p>
</div>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>It is the only way to combine simply multiple sources into one inventory, without the trouble to call ansible with multiple <code>-i {inventory_file}</code> parameters, and keep the door open for extending it with dynamic elements.</p>
<div class="paragraph">
<p>It is also simpler to maintain in a Git repository with multiple maintainers as the chance to get a conflict is reduced because the information is spread among multiple files.
You can drop roles' <code>defaults/main.yml</code> file into the structure and adapt it to your needs very quickly.</p>
</div>
<div class="paragraph">
<p>And finally it gives you a better overview of what is in your inventory without having to dig deeply into it, because already the structure (as revealed with <code>tree</code> or <code>find</code>) gives you a first idea of where to search what. This makes on-boarding of new maintainers a lot easier.</p>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>The following is a complete inventory as described before.
You don&#8217;t absolutely need to start at this level of complexity, but the experience shows that once you get used to it, it is actually a lot easier to understand and maintain than a single file.</p>
<div class="listingblock">
<div class="title">Listing 12. Tree of a structured inventory directory</div>
<div class="content">
<pre>inventory_example/  <i class="conum" data-value="1"></i><b>(1)</b>
├── dynamic_inventory_plugin.yml  <i class="conum" data-value="2"></i><b>(2)</b>
├── dynamic_inventory_script.py  <i class="conum" data-value="3"></i><b>(3)</b>
├── groups_and_hosts  <i class="conum" data-value="4"></i><b>(4)</b>
├── group_vars/  <i class="conum" data-value="5"></i><b>(5)</b>
│   ├── alephs/
│   │   └── capital_letter.yml
│   ├── all/
│   │   └── ansible.yml
│   ├── alphas/
│   │   ├── capital_letter.yml
│   │   └── small_caps_letter.yml
│   ├── betas/
│   │   └── capital_letter.yml
│   ├── greek_letters/
│   │   └── small_caps_letter.yml
│   └── hebrew_letters/
│       └── small_caps_letter.yml
└── host_vars/  <i class="conum" data-value="6"></i><b>(6)</b>
    ├── host1.example.com/
    │   └── ansible.yml
    ├── host2.example.com/
    │   └── ansible.yml
    └── host3.example.com/
        ├── ansible.yml
        └── capital_letter.yml</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>this is your inventory directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a configuration file for a dynamic inventory plug-in</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a dynamic inventory script, old style and deprecated but still used (and supported)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a file containing a static list of hosts and groups, the name isn&#8217;t important (often called <code>hosts</code> but some might confuse it with <code>/etc/hosts</code> and it also contains groups).
See below for an example.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>the <code>group_vars</code> directory to define group variables.
Notice how each group is represented by a directory of its name containing one or more variable files.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>the <code>host_vars</code> directory to define host variables.
Notice how each host is represented by a directory of its name containing one or more variable files.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The groups and hosts file could look as follows, important is to not put any variable definition in this file.</p>
</div>
<div class="listingblock">
<div class="title">Listing 13. Content of the <code>groups_and_hosts</code> file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[all]</span>
<span class="err">host1.example.com</span>
<span class="err">host2.example.com</span>
<span class="err">host3.example.com</span>

<span class="nn">[alphas]</span>
<span class="err">host1.example.com</span>

<span class="nn">[betas]</span>
<span class="err">host2.example.com</span>

<span class="nn">[greek_letters:children]</span>
<span class="err">alphas</span>
<span class="err">betas</span>

<span class="nn">[alephs]</span>
<span class="err">host3.example.com</span>

<span class="nn">[hebrew_letters:children]</span>
<span class="err">alephs</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Listing the hosts under <code>[all]</code> isn&#8217;t really required but makes sure that no host is forgotten, should it not belong to any other group.
The ini-format isn&#8217;t either an obligation but it seems easier to read than YAML, as long as no variable is involved, and makes it easier to maintain in an automated manner using <code>lineinfile</code> (without needing to care for the indentation).</p>
</div>
<div class="paragraph">
<p>Regarding the group and host variables, the name of the variable files is actually irrelevant, you can verify it by calling <code>ansible-inventory -i inventory_example --list</code>:
you will see nowhere the name <code>capital_letter</code> or <code>small_caps_letter</code> (you might see <code>ansible</code> though, but for other reasons&#8230;&#8203;).
We nevertheless follow the convention to name our variable files after the role they are steering (so we assume the roles <code>capital_letter</code> and <code>small_caps_letter</code>).
If correctly written, the <code>defaults/main.yml</code> file from those roles can be simply "dropped" into our inventory structure and adapted accordingly to our needs.
We reserve the name <code>ansible.yml</code> for the Ansible related variables (user, connection, become, etc).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
you can even create a sub-directory in a host&#8217;s or group&#8217;s variable directory and put <em>there</em> the variable files.
This is useful if you have many variables related to the same topic you want to group together but maintain in separate files.
For example Satellite requires many variables to be fully configured, so you can have a structure as follows (again, the name of the sub-directory <code>satellite</code> and of the files doesn&#8217;t matter):
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Listing 14. Example of a complex tree of variables with sub-directory</div>
<div class="content">
<pre>inventory_satellite/
├── groups_and_hosts
└── host_vars/
    └── sat6.example.com/
        ├── ansible.yml
        └── satellite/
            ├── content_views.yml
            ├── hostgroups.yml
            └── locations.yml</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_rely_on_your_inventory_to_loop_over_hosts_dont_create_lists_of_hosts">6.4. Rely on your inventory to loop over hosts, don&#8217;t create lists of hosts</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>To perform the same task on multiple hosts, don&#8217;t create a variable with a list of hosts and loop over it.
Instead use as much as possible the capabilities of your inventory, which is already a kind of list of hosts.</p>
<div class="paragraph">
<p>The anti-pattern is especially obvious in the example of provisioning hosts on some kind of manager.
Commonly seen automation tasks of this kind are spinning up a list of VMs via a hypervisor manager like oVirt/RHV or vCenter, or calling a management tool like Foreman/Satellite or even our beloved AWX/Tower/controller.</p>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>There are 4 main reasons for following this advice:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a list of hosts is more difficult to maintain than an inventory structure, and tends to become very quickly difficult to oversee.
This is especially true as you generally need to maintain your hosts also in your inventory.
This brings us to the 2nd advantage:</p>
</li>
<li>
<p>you avoid duplicating information, as you often need the same kind of information in your inventory that you also need in order to provision your VMs.
In your inventory, you can also use groups to define group variables, automatically inherited by hosts.
You can try to implement a similar inheritance pattern with your list of hosts, but it quickly becomes difficult and <em>hand-crafted</em>.</p>
</li>
<li>
<p>as you loop through the hosts of an inventory, Ansible helps you with <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_strategies.html">parallelization, throttling, etc</a>, all of which you can&#8217;t do easily with your own list (technically, you <em>can</em> combine <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_async.html">async and loop</a> to reach something like this, but it&#8217;s a lot more complex to handle than letting Ansible do the heavy lifting for you).</p>
</li>
<li>
<p>you can very simply <em>limit</em> the play to certain hosts, using for example the <code>--limit</code> parameter of <code>ansible-playbook</code> (or the 'limit' field in Tower/controller), even using groups and patterns.
You can&#8217;t really do this with your own list of hosts.</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Our first idea could be to define managers and hosts first in an inventory:</p>
<div class="listingblock">
<div class="title">Listing 15. Content of the "bad" <code>groups_and_hosts</code> file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[managers]</span>
<span class="err">manager_a</span>
<span class="err">manager_b</span>

<span class="nn">[managed_hosts]</span>
<span class="err">host1</span>
<span class="err">host2</span>
<span class="err">host3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each manager has a list of hosts, which can look like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 16. List of hosts in <code>inventory_bad/host_vars/manager_a/provision.yml</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="nn">---</span>
<span class="na">provision_list_of_hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">host1</span>
    <span class="na">provision_value</span><span class="pi">:</span> <span class="s">uno</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">host2</span>
    <span class="na">provision_value</span><span class="pi">:</span> <span class="s">due</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So that we can loop over the list in this way:</p>
</div>
<div class="listingblock">
<div class="title">Listing 17. The "bad" way to loop over hosts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Provision hosts in a bad way</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">managers</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create some file to simulate an API call to provision a host</span>
      <span class="na">ansible.builtin.copy</span><span class="pi">:</span>
        <span class="na">content</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.provision_value</span><span class="nv"> </span><span class="s">}}</span><span class="se">\n</span><span class="s">"</span>
        <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/tmp/bad_{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}.txt"</span>
        <span class="na">force</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">owner</span><span class="pi">:</span> <span class="s">root</span>
        <span class="na">group</span><span class="pi">:</span> <span class="s">root</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0644"</span>
      <span class="na">loop</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">provision_list_of_hosts</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
check the resulting files using e.g. <code>head -n-0 /tmp/bad_*</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As said, no way to limit the hosts provisioned, and no parallelism.
Compare then with the recommended approach, with a slightly different structure:</p>
</div>
<div class="listingblock">
<div class="title">Listing 18. Content of the "good" <code>groups_and_hosts</code> file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="nn">[managers]</span>
<span class="err">manager_a</span>
<span class="err">manager_b</span>

<span class="nn">[managed_hosts_a]</span>
<span class="err">host1</span>
<span class="err">host2</span>

<span class="nn">[managed_hosts_b]</span>
<span class="err">host3</span>

<span class="nn">[managed_hosts:children]</span>
<span class="err">managed_hosts_a</span>
<span class="err">managed_hosts_b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is now the hosts and their groups which carry the relevant information, it is not anymore parked in one single list (and can be used for other purposes):</p>
</div>
<div class="listingblock">
<div class="title">Listing 19. The "good" variable structure</div>
<div class="content">
<pre>$ cat inventory_good/host_vars/host1/provision.yml
provision_value: uno
$ cat inventory_good/group_vars/managed_hosts_a/provision.yml
manager_hostname: manager_a</pre>
</div>
</div>
<div class="paragraph">
<p>And the provisioning playbook now runs in parallel and can be limited to specific hosts:</p>
</div>
<div class="listingblock">
<div class="title">Listing 20. The "good" way to loop over hosts</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Provision hosts in a good way</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">managed_hosts</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">become</span><span class="pi">:</span> <span class="kc">false</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create some file to simulate an API call to provision a host</span>
      <span class="na">ansible.builtin.copy</span><span class="pi">:</span>
        <span class="na">content</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">provision_value</span><span class="nv"> </span><span class="s">}}</span><span class="se">\n</span><span class="s">"</span>
        <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/tmp/good_{{</span><span class="nv"> </span><span class="s">manager_hostname</span><span class="nv"> </span><span class="s">}}_{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}.txt"</span>
        <span class="na">force</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="na">owner</span><span class="pi">:</span> <span class="s">root</span>
        <span class="na">group</span><span class="pi">:</span> <span class="s">root</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0644"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The result isn&#8217;t overwhelming in this simple setup but you would of course better appreciate if the provisioning would take half an hour instead of a fraction of seconds:</p>
</div>
<div class="listingblock">
<div class="title">Listing 21. Comparison of the execution times between the "good" and the "bad" implementation</div>
<div class="content">
<pre>$ ANSIBLE_STDOUT_CALLBACK=profile_tasks \
	ansible-playbook -i inventory_bad playbook_bad.yml
Saturday 23 October 2021  13:11:45 +0200 (0:00:00.040)       0:00:00.040 ******
Saturday 23 October 2021  13:11:45 +0200 (0:00:00.858)       0:00:00.899 ******
===============================================================================
create some file to simulate an API call to provision a host ------------ 0.86s
$ ANSIBLE_STDOUT_CALLBACK=profile_tasks \
	ansible-playbook -i inventory_good playbook_good.yml
Saturday 23 October 2021  13:11:55 +0200 (0:00:00.040)       0:00:00.040 ******
Saturday 23 October 2021  13:11:56 +0200 (0:00:00.569)       0:00:00.610 ******
===============================================================================
create some file to simulate an API call to provision a host ------------ 0.57s</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
if for some reason, you can&#8217;t follow the recommendation, you can at least avoid duplicating too much information by indirectly referencing the hosts' variables as in <code>"{{ hostvars[item.name]['provision_value'] }}"</code>. Not so bad&#8230;&#8203;
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_restrict_your_usage_of_variable_types">6.5. Restrict your usage of variable types</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Avoid playbook and play variables, as well as <code>include_vars</code>.
Opt for inventory variables instead.</p>
</li>
<li>
<p>Avoid using scoped variables unless required for runtime reasons, e.g. for loops and for temporary variables based on runtime variables.
Another valid exception is when nested variables are too complicated to be defined at once.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>There are <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#understanding-variable-precedence">22 levels of variable precedence</a>.
This is almost impossible to keep in mind for a "normal" human and can lead to all kind of weird behaviors if not under control.
In addition, the use of play(book) variables is not recommended as it blurs the separation between code and data.
The same applies to all constructs including specific variable files as part of the play (i.e. <code>include_vars</code>).
By reducing the number of variable types, you end up with a more simple and overseeable list of variables.
Together with some explanations why they have their specific precedence, so that they become easier to remember and use wisely:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>role defaults (defined in <code>defaults/main.yml</code>), they are&#8230;&#8203; defaults and can be overwritten by anything.</p>
</li>
<li>
<p>inventory vars, they truly represent your desired state.
They have their own internal precedence (group before host) but that&#8217;s easy to remember.</p>
</li>
<li>
<p>host facts don&#8217;t represent a desired state but the current state, and no other variable should have the same name because of <a href="#differentiate">Differentiate clearly between "As-Is" and "To-Be" information</a> so that the precedence doesn&#8217;t really matter.</p>
</li>
<li>
<p>role vars (defined in <code>vars/main.yml</code>) represent constants used by the role to separate code from data, and shouldn&#8217;t either collide with the inventory variables, but can be overwritten by extra vars if you know what you&#8217;re doing.</p>
</li>
<li>
<p>scoped vars, at the block or task level, are local to their scope and hence internal to the role, and can&#8217;t collide with other variable types.</p>
</li>
<li>
<p>runtime vars, defined by register or set_facts, are taking precedence over almost everything defined previously, which makes sense as they represent the current state of the automation.</p>
</li>
<li>
<p>scoped params, at the role or include level this time, are admittedly a bit out of order and should be avoided to limit surprises.</p>
</li>
<li>
<p>and lastly, extra_vars overwrite everything else (even runtime vars, which can be quite surprising)</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
we didn&#8217;t explicitly consider <a href="https://docs.ansible.com/automation-controller/4.4/html/userguide/workflow_templates.html#ug-wf-templates-extravars">Workflow and Job Template variables</a> but they are all extra vars in this consideration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following picture summarizes this list in a simplified and easier to keep in mind way, highlighting which variables are meant to overwrite others:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/variable_precedences.svg" alt="flow of variable precedences in 3 lanes">
</div>
<div class="title">Figure 2. Flow of variable precedences</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
even if we write that variables <em>shouldn&#8217;t</em> overwrite each other, they still all share the same namespace and <em>can</em> potentially overwrite each other.
It is your responsibility as automation author to make sure they don&#8217;t.
</td>
</tr>
</table>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_prefer_inventory_variables_over_extra_vars_to_describe_the_desired_state">6.6. Prefer inventory variables over extra vars to describe the desired state</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Don&#8217;t use extra vars to define your desired state.
Make sure your inventory completely describes how your environment is supposed to look like.
Use extra vars only for troubleshooting, debugging or validation purposes.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Inventory variables are typically in some kind of persistent tracked storage (be it a database or Git), and should be your sole source representing your desired state so that you can refer to it non-ambiguously.
On the other hand, extra vars are bound to a specific job or ansible-call and disappear together with history.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Don&#8217;t use extra vars for the RAM size of VM to create, because this is part of the desired state of your environment, and nobody would know one year down the line if the VM was really created with the proper RAM size according to the state of the inventory.
You may use an extra variable to protect a critical part of a destructive playbook, something like <code>are_you_really_really_sure: true/false</code>, which is validated before e.g. a VM is destroyed and recreated to change parameters which can&#8217;t be changed on the fly.
You can also use extra vars to enforce fact values which can&#8217;t be reproduced easily, like overwriting <code>ansible_memtotal_mb</code> to simulate a RAM size fact of terabytes to validate that your code can cope with it.</p>
<div class="paragraph">
<p>Another example could be the usage of <code>no_log: "{{ no_log_in_case_of_trouble | default(true) }}</code> to exceptionally "uncover" the output of failing tasks even though they are security relevant.</p>
</div>
</dd>
</dl>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_plugins_good_practices">7. Plugins good practices</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Work in Progress&#8230;&#8203;
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_python_guidelines">7.1. Python Guidelines</h3>
<div class="ulist">
<ul>
<li>
<p>Review Ansible guidelines for <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_modules_best_practices.html">modules</a> and <a href="https://docs.ansible.com/ansible/latest/dev_guide/index.html">development</a>.</p>
</li>
<li>
<p>Use <a href="https://pep8.org/">PEP8</a>.</p>
</li>
<li>
<p>File headers and functions should have comments for their intent.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_write_documentation_for_all_plugin_types">7.2. Write documentation for all plugin types</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>All plugins, regardless of type, need documentation that describes the input parameters, outputs, and practical examples of how to use it.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>See the Ansible Developer Guide sections on <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#plugin-configuration-documentation-standards">Plugin Configuration and Documentation Standards</a> and <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_modules_documenting.html#module-documenting">Module Documenting</a> for more details.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_sphinx_rest_formatted_docstrings_in_python_code">7.3. Use sphinx (reST) formatted docstrings in Python code</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Sphinx (reST) formatted docstring are preferred for Ansible development. This includes all parameters, yields, raises, or returns for all classes, private and public functions written in Python.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p><a href="https://peps.python.org/pep-0257/">PEP-257</a> states that: "All modules should normally have docstrings, and all functions and classes exported by a module should also have docstrings. Public methods (including the <em>init</em> constructor) should also have docstrings. A package may be documented in the module docstring of the <em>init</em>.py file in the package directory."</p>
</dd>
<dt class="hdlist1">Examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="sh">"""</span><span class="s">[Summary]

:param [ParamName]: [ParamDescription], defaults to [DefaultParamVal]
:type [ParamName]: [ParamType](, optional)
</span><span class="gp">...</span>
<span class="p">:</span><span class="n">raises</span> <span class="p">[</span><span class="n">ErrorType</span><span class="p">]:</span> <span class="p">[</span><span class="n">ErrorDescription</span><span class="p">]</span>
<span class="bp">...</span>
<span class="p">:</span><span class="k">return</span><span class="p">:</span> <span class="p">[</span><span class="n">ReturnDescription</span><span class="p">]</span>
<span class="p">:</span><span class="n">rtype</span><span class="p">:</span> <span class="p">[</span><span class="n">ReturnType</span><span class="p">]</span>
<span class="sh">"""</span></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_python_type_hints_to_document_variable_types">7.4. Use Python type hints to document variable types.</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Use Python type hints to document variable types.  Type hints are supported in Python 3.5 and greater.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Type hints communicate what type a variable can be expected to be in the code. They can be consumed by static analysis tools to ensure that variable usage is consistent within the code base.</p>
</dd>
<dt class="hdlist1">Examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="n">MyPy</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">static</span> <span class="nb">type</span> <span class="n">checker</span><span class="p">,</span> <span class="n">which</span> <span class="n">could</span> <span class="n">analyze</span> <span class="n">the</span> <span class="n">following</span> <span class="n">snippet</span><span class="p">:</span>
<span class="o">----</span>
<span class="k">def</span> <span class="nf">greeting</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sh">'</span><span class="s">Hello </span><span class="sh">'</span> <span class="o">+</span> <span class="n">name</span>
<span class="o">----</span></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_the_use_of_unittest_is_discouraged_use_pytest_instead">7.5. The use of unittest is discouraged, use pytest instead.</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Use <a href="https://docs.pytest.org/">pytest</a> for writing unit tests for plugins</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Pytest is the testing framework used by Ansible Engineering and will provide the best experience for plugin developers.
The Ansible Developer Guide section on <a href="https://docs.ansible.com/ansible/latest/dev_guide/testing_units_modules.html">unit testing</a> has detailed information on when and how to use unit tests.</p>
</dd>
<dt class="hdlist1">Examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="n">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">)</span>
<span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>

<span class="kn">import</span> <span class="n">pytest</span>

<span class="kn">from</span> <span class="n">ansible.modules.copy</span> <span class="kn">import</span> <span class="n">AnsibleModuleError</span><span class="p">,</span> <span class="n">split_pre_existing_dir</span>
<span class="kn">from</span> <span class="n">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="n">AnsibleModule</span>

<span class="n">ONE_DIR_DATA</span> <span class="o">=</span> <span class="p">((</span><span class="sh">'</span><span class="s">dir1</span><span class="sh">'</span><span class="p">,</span>
                 <span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">dir1</span><span class="sh">'</span><span class="p">]),</span>
                 <span class="p">(</span><span class="sh">'</span><span class="s">dir1</span><span class="sh">'</span><span class="p">,</span> <span class="p">[]),</span>
                 <span class="p">),</span>
                <span class="p">(</span><span class="sh">'</span><span class="s">dir1/</span><span class="sh">'</span><span class="p">,</span>
                 <span class="p">(</span><span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">dir1</span><span class="sh">'</span><span class="p">]),</span>
                 <span class="p">(</span><span class="sh">'</span><span class="s">dir1</span><span class="sh">'</span><span class="p">,</span> <span class="p">[]),</span>
                 <span class="p">),</span>
                <span class="p">)</span>

<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="sh">'</span><span class="s">directory, expected</span><span class="sh">'</span><span class="p">,</span> <span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ONE_DIR_DATA</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">test_split_pre_existing_dir_one_level_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">mocker</span><span class="p">):</span>
    <span class="n">mocker</span><span class="p">.</span><span class="nf">patch</span><span class="p">(</span><span class="sh">'</span><span class="s">os.path.exists</span><span class="sh">'</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span>
    <span class="nf">split_pre_existing_dir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span></code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_formatting_of_manually_maintained_plugin_argspecs">7.6. Formatting of manually maintained plugin argspecs</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Ensure a consistent approach to the way complex argument_specs are formatted within a collection.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>When hand-writing a complex argspec, the author may choose to build up to data structure from multiple dictionaries or vars.
Other authors may choose to implement a complex, nested argspec as a single dictionary.
Within a single collection, select one style and use it consistently.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>Use of a <a href="https://github.com/ansible-collections/cisco.nxos/blob/3.0.0/plugins/module_utils/network/nxos/argspec/bgp_global/bgp_global.py">sngle dictionary</a></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Two different examples of using <a href="https://github.com/ansible-collections/community.aws/blob/stable-3/plugins/modules/ec2_scaling_policy.py#L355-L370">multiple</a> <a href="https://github.com/ansible-collections/amazon.cloud/blob/0.1.0/plugins/modules/backup_report_plan.py#L182-L234">dictionaries</a>.</p>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_keep_plugin_entry_files_to_a_minimal_size">7.7. Keep plugin entry files to a minimal size.</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>Keep the entry file to a plugin to a minimal and easily maintainable size.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Long and complex code files can be difficult to maintain.
Move reusable functions and classes, such as those for data validation or manipulation, to a <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_module_utilities.html">module_utils/</a> (for Ansible modules) or plugin_utils/ (for all other plugin types) file and import them into plugins.
This keeps the Python code easier to read and maintain.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_plugins_should_be_initially_developed_using_the_ansible_plugin_builder">7.8. Plugins should be initially developed using the ansible plugin builder</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>The <a href="https://github.com/ansible-community/ansible.plugin_builder">ansible.plugin_builder</a> is a tool which helps developers scaffold new plugins.</p>
</dd>
</dl>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_use_clear_errorinfo_messages">7.9. Use clear error/info messages</h3>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanations</dt>
<dd>
<p>This will make it easier to troubleshoot failures if they occur</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Error messages that communicate specific details of the failure will aid in resolving the problem.
Unclear error messages such as "Failed!" are unnecessarily obscure.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Information can be displayed to the user based on the verbosity the task is being executed at.</p>
</div>
<div class="paragraph">
<p>The base AnsibleModule class from which all modules should be created provides helper methods for reporting warnings and deprecations, and for exiting the module in the case of a failure.</p>
</div>
<div class="paragraph">
<p>There is a Display class available which enables the display of information at different verbosity levels in all plugin types.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Examples</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="c1"># Causing a module to exit with a failure status
</span>    <span class="k">if</span> <span class="n">checksum</span> <span class="ow">and</span> <span class="n">checksum_src</span> <span class="o">!=</span> <span class="n">checksum</span><span class="p">:</span>
        <span class="n">module</span><span class="p">.</span><span class="nf">fail_json</span><span class="p">(</span>
            <span class="n">msg</span><span class="o">=</span><span class="sh">'</span><span class="s">Copied file does not match the expected checksum. Transfer failed.</span><span class="sh">'</span><span class="p">,</span>
            <span class="n">checksum</span><span class="o">=</span><span class="n">checksum_src</span><span class="p">,</span>
            <span class="n">expected_checksum</span><span class="o">=</span><span class="n">checksum</span>
        <span class="p">)</span>


<span class="c1"># Displaying a warning during module execution, without exiting
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">get_kms_metadata_with_backoff</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">key_id</span><span class="p">)[</span><span class="sh">'</span><span class="s">KeyMetadata</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">key_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">Arn</span><span class="sh">'</span><span class="p">]</span>
<span class="k">except</span> <span class="nf">is_boto3_error_code</span><span class="p">(</span><span class="sh">'</span><span class="s">AccessDeniedException</span><span class="sh">'</span><span class="p">):</span>
    <span class="n">module</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">'</span><span class="s">Permission denied fetching key metadata ({0})</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">key_id</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>


<span class="c1"># Displaying a notice about a deprecation
</span><span class="k">if</span> <span class="n">importer_ssl_client_key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">module</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">client_key</span><span class="sh">'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">importer_ssl_client_key</span> <span class="o">=</span> <span class="n">module</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">client_key</span><span class="sh">'</span><span class="p">]</span>
      <span class="n">module</span><span class="p">.</span><span class="nf">deprecate</span><span class="p">(</span><span class="sh">"</span><span class="s">In Ansible 2.9.2 `feed_client_key` option was added. Until community.general 3.0.0 the default </span><span class="sh">"</span>
                       <span class="sh">"</span><span class="s">value will come from client_key option</span><span class="sh">"</span><span class="p">,</span>
                       <span class="n">version</span><span class="o">=</span><span class="sh">"</span><span class="s">3.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="sh">'</span><span class="s">community.general</span><span class="sh">'</span><span class="p">)</span>


<span class="c1"># Display information only when a user has set an increased level of verbosity
# ansible-playbook -i inventory -vvvv test-playbook.yml
</span><span class="kn">from</span> <span class="n">ansible.utils.display</span> <span class="kn">import</span> <span class="n">Display</span>

<span class="n">display</span> <span class="o">=</span> <span class="nc">Display</span><span class="p">()</span>

<span class="n">lookupfile</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">find_file_in_search_path</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="sh">'</span><span class="s">files</span><span class="sh">'</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
<span class="n">display</span><span class="p">.</span><span class="nf">vvvv</span><span class="p">(</span><span class="sh">"</span><span class="s">File lookup using {0} as file</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">lookupfile</span><span class="p">))</span></code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coding_style_good_practices_for_ansible">8. Coding Style Good Practices for Ansible</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It has proven useful to agree on certain guiding principles as early as possible in any automation project.
Doing so makes it much easier to onboard new Ansible developers.
Project guidelines can also be shared with other departments working on automation which in turn improves the re-usability of playbooks, roles, modules, and documentation.</p>
</div>
<div class="paragraph">
<p>Another major benefit is that it makes code review process less time-consuming and more reliable; making both the developer and reviewer more likely to engage in a constructive review conversation.</p>
</div>
<div class="paragraph">
<p>This section contains suggestions for such coding-style guidelines.
The list is neither complete nor are all of the guidelines necessary in every automation project.
Experience shows that it makes sense to start with a minimum set of guidelines because the longer the list the lower the chance of people actually reading through it.
Additional guidelines can always be added later should the situation warrant it.</p>
</div>
<div class="sect2">
<h3 id="_naming_things">8.1. Naming things</h3>
<div class="ulist">
<ul>
<li>
<p>Use valid Python identifiers following standard naming conventions of being in <code>snake_case_naming_schemes</code> for all YAML or Python files, variables, arguments, repositories, and other such names (like dictionary keys).</p>
</li>
<li>
<p>Do not use special characters other than underscore in variable names, even if YAML/JSON allow them.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Using such variables in Jinja2 or Python would be then very confusing and probably not functional.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>even when Ansible currently allows names that are not valid identifier, it may stop allowing them in the future, as it happened in the past already.
Making all names valid identifiers will avoid encountering problems in the future. Dictionary keys that are not valid identifiers are also less intuitive to use in Jinja2 (a dot in a dictionary key would be particularly confusing).</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Use mnemonic and descriptive names that are human-readable and do not shorten more than necessary.
A pattern <code>object[_feature]_action</code> has proven useful as it guarantees a proper sorting in the file system for roles and playbooks.
Systems support long identifier names, so use them!</p>
</li>
<li>
<p>Avoid numbering roles and playbooks, you&#8217;ll never know how they&#8217;ll be used in the future.</p>
</li>
<li>
<p>Name all tasks, plays, and task blocks to improve readability.</p>
</li>
<li>
<p>Write task names in the imperative (e.g. "Ensure service is running"), this communicates the action of the task.</p>
</li>
<li>
<p>Avoid abbreviations in names, or use capital letter for abbreviations where it cannot be avoided.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_yaml_and_jinja2_syntax">8.2. YAML and Jinja2 Syntax</h3>
<div class="ulist">
<ul>
<li>
<p>Indent at two spaces</p>
</li>
<li>
<p>Indent list contents beyond the list definition</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="listingblock">
<div class="title">Listing 22. Do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">example_list</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">example_element_1</span>
  <span class="pi">-</span> <span class="s">example_element_2</span>
  <span class="pi">-</span> <span class="s">example_element_3</span>
  <span class="pi">-</span> <span class="s">example_element_4</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 23. Don&#8217;t do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">example_list</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">example_element_1</span>
<span class="pi">-</span> <span class="s">example_element_2</span>
<span class="pi">-</span> <span class="s">example_element_3</span>
<span class="pi">-</span> <span class="s">example_element_4</span></code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Split long expressions into multiple lines.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Long lines are difficult to read, and many teams even ask for a line length limit around 120-150 characters.
ansible-lint defaults to 82 characters per line - see (<a href="https://ansible-lint.readthedocs.io/rules/yaml/">Ansible Lint YAML rules</a>).
You don&#8217;t want to have to skip <code>yaml[line-length]</code> in your <code>.ansible-lint</code>, or litter your code with <code># noqa yaml[line-length]</code>.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<p>there are multiple ways to avoid long lines but the most generic one is to use the YAML folding sign (<code>&gt;-</code>):</p>
<div class="listingblock">
<div class="title">Listing 24. Usage of the YAML folding sign</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Call a very long command line</span>
  <span class="na">ansible.builtin.command</span><span class="pi">:</span> <span class="pi">&gt;-</span>
    <span class="s">echo Lorem ipsum dolor sit amet, consectetur adipiscing elit.</span>
    <span class="s">Maecenas mollis, ante in cursus congue, mauris orci tincidunt nulla,</span>
    <span class="s">non gravida tortor mi non nunc.</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set a very long variable</span>
  <span class="na">ansible.builtin.set_fact</span><span class="pi">:</span>
    <span class="na">meaningless_variable</span><span class="pi">:</span> <span class="pi">&gt;-</span>
      <span class="s">Ut ac neque sit amet turpis ullamcorper auctor.</span>
      <span class="s">Cras placerat dolor non ipsum posuere malesuada at ac ipsum.</span>
      <span class="s">Duis a neque fermentum nulla imperdiet blandit.</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Always use the sign <code>&gt;-</code> instead of <code>&gt;</code> unless you are absolutely sure the trailing newline is not significant.
The sign <code>&gt;</code> adds a newline character to the last line, effectively turning <code>non nunc.</code> at the end of the example string above into  <code>"non nunc.\n"</code>, and <code>&gt;-</code> doesn&#8217;t add the newline character.
It is really easy to introduce an error by using <code>&gt;</code> and silently add a newline to a variable, like a filename, which leads to strange, hard to decipher errors.
See section "Wrap longer lines of code" for more information about line wrapping.
</td>
</tr>
</table>
</div>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>If the <code>when:</code> condition results in a line that is too long, and is an <code>and</code> expression, then break it into a list of conditions.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Ansible will <code>and</code> the list elements together (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html#basic-conditionals-with-when">Ansible UseGuide » Conditionals</a>).
Multiple conditions that all need to be true (a logical <code>and</code>) can also be specified as a list, but beware of bare variables in <code>when:</code>.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="listingblock">
<div class="title">Listing 25. Do this</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">when</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">myvar is defined</span>
  <span class="pi">-</span> <span class="s">myvar | bool</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 26. instead of this</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">when</span><span class="pi">:</span> <span class="s">myvar is defined and myvar | bool</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>All roles need to, minimally, pass a basic ansible-playbook syntax check run</p>
</li>
<li>
<p>Spell out all task arguments in YAML style and do not use <code>key=value</code> type of arguments</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="listingblock">
<div class="title">Listing 27. Do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Print a message</span>
    <span class="na">ansible.builtin.debug</span><span class="pi">:</span>
      <span class="na">msg</span><span class="pi">:</span> <span class="s">This is how it's done.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 28. Don&#8217;t do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Print a message</span>
    <span class="na">ansible.builtin.debug</span><span class="pi">:</span> <span class="s">msg="This is the exact opposite of how it's done."</span></code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Use <code>true</code> and <code>false</code> for boolean values in playbooks.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Do not use the Ansible-specific <code>yes</code> and <code>no</code> as boolean values in YAML as these are completely custom extensions used by Ansible and are not part of the YAML spec and also avoid the use of the Python-style <code>True</code> and <code>False</code> for boolean values in playbooks.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p><a href="https://yaml.org/type/bool.html">YAML 1.1</a> allows all variants whereas <a href="https://yaml.org/spec/1.2/spec.html#id2803629">YAML 1.2</a> allows only true/false, and we want to be ready for when it becomes the default, and avoid a massive migration effort.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Avoid comments in playbooks when possible.
Instead, ensure that the task <code>name</code> value is descriptive enough to tell what a task does.
Variables are commented in the <code>defaults</code> and <code>vars</code> directories and, therefore, do not need explanation in the playbooks themselves.</p>
</li>
<li>
<p>Use a single space separating the template markers from the variable name inside all Jinja2 template points.
For instance, always write it as <code>{{ variable_name_here }}</code>.
The same goes if the value is an expression. <code>{{ variable_name | default('hiya, doc') }}</code></p>
</li>
<li>
<p>When naming files, use the <code>.yml</code> extension and <em>not</em> <code>.yaml</code>.
<code>.yml</code> is what <code>ansible-galaxy init</code> does when creating a new role template.</p>
</li>
<li>
<p>Use double quotes for YAML strings with the exception of Jinja2 strings which will use single quotes.</p>
</li>
<li>
<p>Do not use quotes unless you have to, especially for short module-keyword-like strings like <code>present</code>, <code>absent</code>, etc.
But do use quotes for user-side strings such as descriptions, names, and messages.</p>
</li>
<li>
<p>Even if JSON is valid YAML and Ansible understands it, do only use JSON syntax if it makes sense (e.g. a variable file automatically generated) or adds to the readability.
In doubt, nobody expects JSON so stick to YAML.</p>
</li>
<li>
<p>Break up lengthy Jinja templates into multiple templates when there are distinct logical sections.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Long and complex Jinja templates can be difficult to maintain and debug. By splitting excessively long templates into logical componets that can be included as-needed, each template will be easier to maintain.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Jinja templates should not be used to create structured data but instead text and semi-structured data. Filter plugins are preferred over Jinja templates for the use of data manipulation or transformation.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>When working with structured data or data transformations it is preferable to use a programming language (such as Python) that has better support and tooling to do this kind of work.
Custom filter plugins can be written to handle complex or unique use-cases.
Tasks will be much more legible if data is managed and manipulated via plugins than with in-line Jinja.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_ansible_guidelines">8.3. Ansible Guidelines</h3>
<div class="ulist">
<ul>
<li>
<p>Ensure that all tasks are idempotent.</p>
</li>
<li>
<p><a href="https://github.com/ansible/ansible/issues/10374">Ansible variables use lazy evaluation.</a></p>
</li>
<li>
<p>Prefer the command module over the shell module unless you explicitly need shell functionality such as, e.g., piping.
Even better, use a dedicated module, if it exists.
If not, see the <a href="#check-mode-and-idempotency-issues">section</a> about idempotency and check mode and make sure that your task is idempotent and supports check mode properly;
your task will likely need options such as <code>changed_when:</code> and maybe <code>check_mode:</code>).</p>
</li>
<li>
<p>Anytime <code>command</code> or <code>shell</code> modules are used, add a comment in the code with justification to help with future maintenance.</p>
</li>
<li>
<p>Use the <code>| bool</code> filter when using bare variables (expressions consisting of just one variable reference without any operator) in <code>when</code>.</p>
</li>
<li>
<p>Break complex task files down into discrete parts.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Task files that are very or and/or contain highly nested blocks are difficult to maintain.
Breaking a large or complex task file into multiple discrete files makes it easier to read and understand what is being done in each part.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Use bracket notation instead of dot notation for value retrieval (e.g. <code>item['key']</code> vs. <code>item.key</code>)</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Dot notation will fail in some cases (such as when a variable name includes a hyphen) and it&#8217;s better to stay consistent than to switch between the two options within a role or playbook.
Additionally, some key names collide with attributes and methods of Python dictionaries such as <code>count</code>, <code>copy</code>, <code>title</code>, and others (refer to the <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#referencing-key-value-dictionary-variables">Ansible User Guide</a> for an extended list)</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>This <a href="https://blog.networktocode.com/post/Exploring-Jinja-Variable-Syntax-in-Ansible">post</a> provides an excellent demonstration of how using dot notation syntax can impact your playbooks.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Do not use <code>meta: end_play</code>.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>It aborts the whole play instead of a given host (with multiple hosts in the inventory).
If absolutely necessary, consider using <code>meta: end_host</code>.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Task names can be made dynamic by using variables wrapped in Jinja2 templates at the end of the string</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>This can help with reading the logs.
For example, if the task is managing one of several devices, and you want the task name output to show the device being managed.
However, the template must come at the <strong>end</strong> of the string - see (<a href="https://ansible-lint.readthedocs.io/rules/name/">Ansible Lint name template rule</a>).
Note that in some cases, it can make it harder for users to correlate the logs to the code.
For example, if there is a log message like "Manage the disk device /dev/dsk/0001", and the user tries to do something like <code>grep "Manage the disk device /dev/dsk/0001" rolename/tasks/*.yml</code> to figure out which task this comes from, they will not find it.
If the template comes at the end of the string, the user will know to omit the device name from <code>grep</code>.
A better way to debug is to use <code>ansible-playbook -vv</code>, which will show the exact file and line number of the task.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>.Do this:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Manage the disk device {{ storage_device_name }}</span>
    <span class="na">some.module</span><span class="pi">:</span>
      <span class="na">device</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">storage_device_name</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 29. Don&#8217;t do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Manage {{ storage_device_name }}, the disk device</span>
    <span class="na">some.module</span><span class="pi">:</span>
      <span class="na">device</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">storage_device_name</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
</div>
</details>
</li>
<li>
<p>Do not use variables (wrapped in Jinja2 templates) for play names; variables don&#8217;t get expanded properly there.
The same applies to loop variables (by default <code>item</code>) in task names within a loop.
They, too, don&#8217;t get properly expanded and hence are not to be used there.</p>
</li>
<li>
<p>Do not override role defaults or vars or input parameters using <code>set_fact</code>.
Use a different name instead.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>a fact set using <code>set_fact</code> can not be unset and it will override the role default or role variable in all subsequent invocations of the role in the same playbook.
A fact has a different priority than other variables and not the highest, so in some cases overriding a given parameter will not work because the parameter has a higher priority (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">Ansible User Guide » Using Variables</a>)</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Use the smallest scope for variables.
Facts are global for playbook run, so it is preferable to use other types of variables. Therefore limit (preferably avoid) the use of <code>set_fact</code>.
Role variables are exposed to the whole play when the role is applied using <code>roles:</code> or <code>import_role:</code>. A more restricted scope such as task or block variables is preferred.</p>
</li>
<li>
<p>Beware of <code>ignore_errors: true</code>; especially in tests.
If you set on a block, it will ignore all the asserts in the block ultimately making them pointless.</p>
</li>
<li>
<p>Do not use the <code>eq</code>, <code>equalto</code>, or <code>==</code> Jinja tests introduced in Jinja 2.10, use Ansible built-in <code>match</code>, <code>search</code>, or <code>regex</code> instead.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>The issue is only with Jinja versions older than 2.10.
RPM distributions of Ansible generally use the underlying OS platform python library for Jinja e.g. python-jinja2.
This is especially problematic on EL7.
The only supported Ansible RPM on that platform is 2.9, which uses the EL7 platform python-jinja2 library, which is 2.7 (and will likely never be upgraded).
As of mid-2022, there are many users using EL7 for the control node.
I believe this means AAP 1.x users will also be affected.
Users not affected:</p>
<div class="ulist">
<ul>
<li>
<p>AAP 2.x users - there should be an option to use EL8 runners, or otherwise, build the EEs in such a way as to use Jinja 2.11 or later</p>
</li>
<li>
<p>Users running Ansible from a pip install</p>
</li>
<li>
<p>Users running Ansible installed via RPM on EL8 or later</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>These tests are not present in versions of Jinja older than 2.10, which are used on older controller platforms, such as EL7.
If you want to ensure that your code works on older platforms, use the built-in Ansible tests such as (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html#testing-strings">match</a>), (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html#testing-strings">search</a>), or (<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tests.html#testing-strings">regex</a>) instead.</p>
</dd>
<dt class="hdlist1">Example</dt>
<dd>
<p>You have a <code>list</code> of <code>dict</code>, and you want to filter out elements that have the key <code>type</code> with the value <code>bad_type</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Listing 30. Do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Do something</span>
    <span class="na">some.module</span><span class="pi">:</span>
      <span class="na">param</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">list_of_dict</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">rejectattr('type',</span><span class="nv"> </span><span class="s">'search',</span><span class="nv"> </span><span class="s">'^bad_type$')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 31. Don&#8217;t do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">tasks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Do something</span>
    <span class="na">some.module</span><span class="pi">:</span>
      <span class="na">param</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">list_of_dict</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">rejectattr('type',</span><span class="nv"> </span><span class="s">'eq',</span><span class="nv"> </span><span class="s">'bad_type')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>match</code>, <code>search</code>, or <code>regex</code>, and you want an exact match, you must specify the regex <code>^STRING$</code>, otherwise, you will match partial strings.</p>
</div>
</div>
</details>
</li>
<li>
<p>Avoid the use of <code>when: foo_result is changed</code> whenever possible.
Use handlers, and, if necessary, handler chains to achieve this same result.</p>
</li>
<li>
<p>Use the various include/import statements in Ansible.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Explanation</dt>
<dd>
<p>Doing so can lead to simplified code and a reduction of repetition.
This is the closest that Ansible comes to callable sub-routines, so use judgment about callable routines to know when to similarly include a sub playbook.
Some examples of good times to do so are</p>
<div class="ulist">
<ul>
<li>
<p>When a set of multiple commands share a single <code>when</code> conditional</p>
</li>
<li>
<p>When a set of multiple commands are being looped together over a list of items</p>
</li>
<li>
<p>When a single large role is doing many complicated tasks and cannot easily be broken into multiple roles, but the process proceeds in multiple related stages</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Avoid calling the <code>package</code> module iteratively with the <code>{{ item }}</code> argument, as this is impressively more slow than calling it with the line <code>name: "{{ foo_packages }}"</code>.
The same can go for many other modules that can be given an entire list of items all at once.</p>
</li>
<li>
<p>Use meta modules when possible.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>This will allow our playbooks to run on the widest selection of operating systems possible without having to modify any more tasks than is necessary.</p>
</dd>
<dt class="hdlist1">Examples</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Instead of using the <code>upstart</code> and <code>systemd</code> modules, use the <code>service</code>
module when at all possible.</p>
</li>
<li>
<p>Similarly for package management, use <code>package</code> instead of <code>yum</code> or <code>dnf</code> or
similar.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Avoid the use of <code>lineinfile</code> wherever that might be feasible.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Slight miscalculations in how it is used can lead to a loss of idempotence.
Modifying config files with it can cause the Ansible code to become arcane and difficult to read, especially for someone not familiar with the file in question.
Try editing files directly using other built-in modules (e.g. <code>ini_file</code>, <code>blockinfile</code>, <code>xml</code>), or reading and parsing.
If you are modifying more than a tiny number of lines or in a manner more than trivially complex, try leveraging the <code>template</code> module, instead.
This will allow the entire structure of the file to be seen by later users and maintainers.
The use of <code>lineinfile</code> should include a comment with justification.
Alternatively, most configuration files have their own modules, such as <a href="https://docs.ansible.com/ansible/latest/collections/community/general/ssh_config_module.html">community.general.ssh_config</a> or <a href="https://docs.ansible.com/ansible/latest/collections/community/general/nmcli_module.html">community.general.nmcli</a>.
Using these make code cleaner to read and ensure idempotence.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Limit use of the <code>copy</code> module to copying remote files, static files, and to uploading binary blobs.
For most file pushes, use the <code>template</code> module.
Even if there currently is nothing in the file that is being templated, if there is the possibility in the future that it might be added, having the file handled by the <code>template</code> module now makes adding that functionality much simpler than if the file is initially handled by the <code>copy</code> module and then needs to be moved before it can be edited.</p>
</li>
<li>
<p>When using the <code>template</code> module, append <code>.j2</code> to the template file name.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Example</dt>
<dd>
<p>If you want to use the <code>ansible.builtin.template</code> module to create a file called <code>example.conf</code> somewhere on the managed host, name the template for this file <code>templates/example.conf.j2</code>.</p>
</dd>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>When you are at the stage of writing a template file you usually already know how the file should end up looking on the file system, so at that point it is convenient to use Jinja2 syntax highlighting to make sure your templating syntax checks out.
Should you need syntax highlighting for whatever language the target file should be in, it is very easy to define in your editor settings to use, e.g., HTML syntax highlighting for all files ending in <code>.html.j2</code>.
It is much less straightforward to automatically enable Jinja2 syntax highlighting for <em>some</em> files ending on <code>.html</code>.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Keep filenames and templates as close to the name on the destination system as possible.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>This will help with both editor highlighting as well as identifying source and destination versions of the file at a glance.
Avoid duplicating the remote full path in the role directory, however, as that creates unnecessary depth in the file tree for the role.
Grouping sets of similar files into a subdirectory of <code>templates</code> is allowable, but avoid unnecessary depth to the hierarchy.</p>
</dd>
</dl>
</div>
</div>
</details>
</li>
<li>
<p>Using agnostic modules like <code>package</code> only makes sense if the features required are very limited.
In many cases, if the platform is different, the package name is also different so that using <code>package</code> doesn&#8217;t help a lot.
Prefer then the more specific <code>yum</code>, <code>dnf</code> or <code>apt</code> module if you anyway need to differentiate.</p>
</li>
<li>
<p>Use <code>float</code>, <code>int</code>, and <code>bool</code> filters to "cast" public API variables to ensure type safety, especially for numeric operations in Jinja.</p>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Example</dt>
<dd>
<p>Variables set by users in the public API are not guaranteed to be any specific data type, and may be <code>str</code> type when some numeric type is expected:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>&gt; ansible -c local -i localhost --extra-vars int_val=1 localhost -m debug -a "msg={{ int_val &lt; 0 }}"
localhost | FAILED! =&gt; {
    "msg": "Unexpected templating type error occurred on ({{ int_val &lt; 0 }}): '&lt;' not supported between instances of 'str' and 'int'"
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>It is generally not possible to guarantee that all user inputs retain their desired numeric type, and if not, will likely be <code>str</code> type.
If you use numeric variables where the value comes from user input, use the <code>float</code>, <code>int</code>, and <code>bool</code> filters to "cast" the values to the type for numeric operations.
If you are simply converting the value to a string, you do not have to use the cast.
Numeric operations include:</p>
<div class="ulist">
<ul>
<li>
<p>arithmetic: <code>int_var + 3</code>, <code>float_var * 3.14159</code></p>
</li>
<li>
<p>comparison: <code>int_var == 0</code>, <code>float_var &gt;= 2.71828</code></p>
</li>
<li>
<p>unary: <code>-int_var</code>, <code>+float_var</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here are some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>&gt; ansible -c local -i localhost --extra-vars int_val=1 localhost -m debug -a "msg={{ int_val | int &lt; 0 }}"
localhost | SUCCESS =&gt; {
    "msg": false
}

&gt; ansible -c local -i localhost -e float_val=0.5 localhost -m debug -a "msg='float_val is less than 1.0 {{ float_val | float + 0.1 &lt; 1.0 }}'"
localhost | SUCCESS =&gt; {
    "msg": "float_val is less than 1.0 True"
}</code></pre>
</div>
</div>
</div>
</details>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_longer_lines_of_code">8.4. Wrap longer lines of code</h3>
<div class="paragraph">
<p>ansible-lint has a pretty short line length, which causes problems if you are trying to use good programming practices by having descriptive variable names, which usually end up being quite long.
Here are some examples of how to deal with line wrapping in common scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jinja expressions can be wrapped.
Within the Jinja expression, whitespace and newline characters aren&#8217;t significant, so take advantage of this to wrap lines into as readable a form as possible.
Remember, in a <code>when</code>, <code>that</code>, <code>failed_when</code>, or other such keywords, you can just write Jinja code - you do not need the <code>"{{ &#8230;&#8203; }}"</code></p>
</li>
<li>
<p>Start an expression with '{{' followed by newline if the line will otherwise be too long.
But what if the code is already indented a lot, and the variable I&#8217;m assigning to is already very long, and I can&#8217;t put anything else on the line?
Just start the assignment on the next line.</p>
</li>
<li>
<p>Use backslash escapes in double quoted strings.
But what if I have a very long string that I cannot use <code>&gt;-</code> to wrap because I cannot have extra spaces in the value e.g. like a url value?
Use a backslash escape in a double quoted string.
YAML will concatenate the values with no spaces.</p>
</li>
</ul>
</div>
<details>
<summary class="title">Details</summary>
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">Rationale</dt>
<dd>
<p>Use of whitespace and multi-line indentation makes expressions easier to read.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Listing 32. Do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Wrap long Jinja expressions</span>
  <span class="na">foo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">somefilter('with',</span><span class="nv"> </span><span class="s">'many',</span><span class="nv"> </span><span class="s">'arguments')</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">another_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">a_very.long_variable.name |</span>
    <span class="s">somefilter('with', 'many', 'arguments') |</span>
    <span class="s">another_filter | list</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Wrap when first line is already too long</span>
  <span class="na">very_indented_foo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span>
    <span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">somefilter('with',</span><span class="nv"> </span><span class="s">'many',</span><span class="nv"> </span><span class="s">'arguments')</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">another_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">\</span>
    <span class="s">a_very.long_variable.name |</span>
    <span class="s">somefilter('with', 'many', 'arguments') |</span>
    <span class="s">another_filter | list | length &gt; </span><span class="m">0</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set some test variables</span>
  <span class="na">set_fact</span><span class="pi">:</span>
    <span class="na">my_very_long_variable_1</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__pre_digest</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">filter1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">my_very_long_variable_2</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">__pre_digest</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">filter2</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">__pre_digest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">some_filter</span><span class="nv"> </span><span class="s">}}"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Use a very long URL</span>
  <span class="na">uri</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_hostname</span><span class="nv"> </span><span class="s">}}:</span><span class="se">\
</span>      <span class="s">{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_port</span><span class="nv"> </span><span class="s">}}</span><span class="se">\
</span>      <span class="s">{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_uri</span><span class="nv"> </span><span class="s">}}?</span><span class="se">\
</span>      <span class="s">{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_query</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 33. Don&#8217;t do this:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Very long line with Jinja expression</span>
  <span class="na">foo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">somefilter('with',</span><span class="nv"> </span><span class="s">'many',</span><span class="nv"> </span><span class="s">'arguments')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">another_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">First line is already too long</span>
  <span class="na">very_indented_foo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">somefilter('with',</span><span class="nv"> </span><span class="s">'many',</span><span class="nv"> </span><span class="s">'arguments')</span><span class="nv"> </span><span class="s">|</span>
    <span class="s">another_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">list</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">a_very.long_variable.name |</span>
    <span class="s">somefilter('with', 'many', 'arguments') |</span>
    <span class="s">another_filter | list | length &gt; </span><span class="m">0</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Redundancy in expressions</span>
  <span class="na">set_fact</span><span class="pi">:</span>
    <span class="na">my_very_long_variable_1</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">some_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">filter1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">my_very_long_variable_2</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">a_very.long_variable.name</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">some_filter</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">filter2</span><span class="nv"> </span><span class="s">}}"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">URL string is too long</span>
  <span class="na">uri</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_hostname</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_port</span><span class="nv"> </span><span class="s">}}{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_uri</span><span class="nv"> </span><span class="s">}}{{</span><span class="nv"> </span><span class="s">my_very_long_value_for_query</span><span class="nv"> </span><span class="s">}}"</span></code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2025-05-30 (commit: 7b44f1d2333680052c967964d84301ad7d2128e7)<br>
</div>
</div>
</body>
</html>